"use strict";(self.webpackChunkpackit_dev=self.webpackChunkpackit_dev||[]).push([[55572],{10883:(e,a,t)=>{t.d(a,{A:()=>n});const n=t.p+"assets/images/checks_vm_image_build-0ec652132670f4da590dca9dc372a468.png"},15680:(e,a,t)=>{t.d(a,{xA:()=>p,yg:()=>d});var n=t(96540);function o(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function i(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function r(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?i(Object(t),!0).forEach((function(a){o(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function l(e,a){if(null==e)return{};var t,n,o=function(e,a){if(null==e)return{};var t,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)t=i[n],a.indexOf(t)>=0||(o[t]=e[t]);return o}(e,a);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)t=i[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var s=n.createContext({}),u=function(e){var a=n.useContext(s),t=a;return e&&(t="function"==typeof e?e(a):r(r({},a),e)),t},p=function(e){var a=u(e.components);return n.createElement(s.Provider,{value:a},e.children)},c="mdxType",g={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},m=n.forwardRef((function(e,a){var t=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=u(t),m=o,d=c["".concat(s,".").concat(m)]||c[m]||g[m]||i;return t?n.createElement(d,r(r({ref:a},p),{},{components:t})):n.createElement(d,r({ref:a},p))}));function d(e,a){var t=arguments,o=a&&a.mdxType;if("string"==typeof e||o){var i=t.length,r=new Array(i);r[0]=m;var l={};for(var s in a)hasOwnProperty.call(a,s)&&(l[s]=a[s]);l.originalType=e,l[c]="string"==typeof e?e:o,r[1]=l;for(var u=2;u<i;u++)r[u]=t[u];return n.createElement.apply(null,r)}return n.createElement.apply(null,t)}m.displayName="MDXCreateElement"},16161:(e,a,t)=>{t.d(a,{A:()=>n});const n=t.p+"assets/images/ami-link-2bb9d9e9a1da6c8e18ca31b39db13789.png"},23568:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>s,contentTitle:()=>r,default:()=>g,frontMatter:()=>i,metadata:()=>l,toc:()=>u});var n=t(58168),o=(t(96540),t(15680));const i={title:"Customize AWS cloud images with Image Builder and Packit",date:new Date("2024-01-22T00:00:00.000Z"),authors:"mmassari",tags:["image-builder"]},r=void 0,l={permalink:"/posts/aws-and-image-builder",editUrl:"https://github.com/packit/packit.dev/tree/main/posts/aws-and-image-builder/index.md",source:"@site/posts/aws-and-image-builder/index.md",title:"Customize AWS cloud images with Image Builder and Packit",description:"Have you ever wanted to bring your pull request changes in a cloud image easily?",date:"2024-01-22T00:00:00.000Z",formattedDate:"January 22, 2024",tags:[{label:"image-builder",permalink:"/posts/tags/image-builder"}],readingTime:5.5,hasTruncateMarker:!0,authors:[{name:"Maja Massarini",email:"mmassari@redhat.com",url:"https://github.com/majamassarini",imageURL:"https://github.com/majamassarini.png",key:"mmassari"}],frontMatter:{title:"Customize AWS cloud images with Image Builder and Packit",date:"2024-01-22T00:00:00.000Z",authors:"mmassari",tags:["image-builder"]},prevItem:{title:"DevConf.CZ 2024 and week around for Packit",permalink:"/posts/devconf-2024"},nextItem:{title:"Introduction to specfile library",permalink:"/posts/specfile-introduction"}},s={authorsImageUrls:[void 0]},u=[{value:"Prerequisites",id:"prerequisites",level:3},{value:"Procedure",id:"procedure",level:3},{value:"Install Packit",id:"install-packit",level:2},{value:"Setup Packit",id:"setup-packit",level:2},{value:"copr_build job",id:"copr_build-job",level:3},{value:"vm_image_build job",id:"vm_image_build-job",level:3},{value:"Create, comment and test a pull request!",id:"create-comment-and-test-a-pull-request",level:2}],p={toc:u},c="wrapper";function g(e){let{components:a,...i}=e;return(0,o.yg)(c,(0,n.A)({},p,i,{components:a,mdxType:"MDXLayout"}),(0,o.yg)("p",null,"Have you ever wanted to bring your pull request changes in a cloud image easily?\nCurious about how easy it can be? With Packit, it can be just about commenting on your pull request with ",(0,o.yg)("inlineCode",{parentName:"p"},"/packit vm-image-build"),"."),(0,o.yg)("p",null,"With the above command, Packit automates all the manual steps needed to create an\nRPM package with your pull request changes and asks the Image Builder to install it\ninside a brand new cloud image.\nLet's have a look at the prerequisites for this."),(0,o.yg)("h1",{id:"join-the-red-hat-developer-program"},"Join the Red Hat Developer Program"),(0,o.yg)("p",null,"If you don't already have a business account you can create a\n",(0,o.yg)("em",{parentName:"p"},"Red Hat Developer account")," at no cost ",(0,o.yg)("a",{parentName:"p",href:"https://developers.redhat.com/about"},"here"),"."),(0,o.yg)("p",null,"You need a subscription in order to use the\n",(0,o.yg)("a",{parentName:"p",href:"https://console.redhat.com/insights/image-builder"},"Image Builder service"),"\nand launch the builded images in the ",(0,o.yg)("a",{parentName:"p",href:"https://aws.amazon.com/console/"},"AWS management console"),"."),(0,o.yg)("h1",{id:"prepare-to-upload-aws-ami-images"},"Prepare to upload AWS AMI images"),(0,o.yg)("p",null,"Before uploading an AWS AMI image, you must configure the AWS system for receiving them."),(0,o.yg)("h3",{id:"prerequisites"},"Prerequisites"),(0,o.yg)("ul",null,(0,o.yg)("li",{parentName:"ul"},"You must have an Access Key ID configured in the ",(0,o.yg)("a",{parentName:"li",href:"https://aws.amazon.com/iam/"},"AWS IAM account manager"),"."),(0,o.yg)("li",{parentName:"ul"},"You must have a writable ",(0,o.yg)("a",{parentName:"li",href:"https://docs.aws.amazon.com/AmazonS3/latest/gsg/CreatingABucket.html"},"S3 bucket")," prepared.")),(0,o.yg)("h3",{id:"procedure"},"Procedure"),(0,o.yg)("p",null,"Follow ",(0,o.yg)("a",{parentName:"p",href:"https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/composing_a_customized_rhel_system_image/creating-cloud-images-with-composer_composing-a-customized-rhel-system-image#preparing-for-uploading-aws-ami-images_creating-cloud-images-with-composer"},"these steps"),"\nto satisfy the above prerequisites."),(0,o.yg)("h1",{id:"the-manual-steps"},"The manual steps"),(0,o.yg)("p",null,"Are you wondering what are the manual steps for bringing your pull request changes\nin a cloud image and why you should automate them?"),(0,o.yg)("p",null,"There could be many ways to achieve this goal but let's see together the closest to our\nautomated solution. Below you can find a summary of all the needed manual steps;\nI am quite sure after reading them, you will want to automate them with Packit!"),(0,o.yg)("ul",null,(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("p",{parentName:"li"},"Build an RPM package with your pull request changes through ",(0,o.yg)("strong",{parentName:"p"},"COPR"),", go to ",(0,o.yg)("a",{parentName:"p",href:"https://copr.fedorainfracloud.org"},"https://copr.fedorainfracloud.org")),(0,o.yg)("ol",{parentName:"li"},(0,o.yg)("li",{parentName:"ol"},"Install ",(0,o.yg)("inlineCode",{parentName:"li"},"copr-cli"),"."),(0,o.yg)("li",{parentName:"ol"},"Create your account and service token."),(0,o.yg)("li",{parentName:"ol"},"Add your token to `~/.config/copr."),(0,o.yg)("li",{parentName:"ol"},"Create a new COPR project."),(0,o.yg)("li",{parentName:"ol"},"Start a build with your local pull request changes using ",(0,o.yg)("inlineCode",{parentName:"li"},"copr-cli"),"."),(0,o.yg)("li",{parentName:"ol"},(0,o.yg)("strong",{parentName:"li"},"WAIT for the build to finish"),"."))),(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("p",{parentName:"li"},"Create a new cloud image through the ",(0,o.yg)("strong",{parentName:"p"},"Image Builder console"),", go to ",(0,o.yg)("a",{parentName:"p",href:"https://console.redhat.com/insights/image-builder"},"https://console.redhat.com/insights/image-builder")),(0,o.yg)("ol",{parentName:"li",start:7},(0,o.yg)("li",{parentName:"ol"},"Login with your ",(0,o.yg)("em",{parentName:"li"},"Red Hat developer")," account."),(0,o.yg)("li",{parentName:"ol"},"Click on the ",(0,o.yg)("inlineCode",{parentName:"li"},"Create Image")," button, choose ",(0,o.yg)("em",{parentName:"li"},"AWS image")," type and follow the wizard."),(0,o.yg)("li",{parentName:"ol"},(0,o.yg)("strong",{parentName:"li"},"WAIT for the build to finish"),"."),(0,o.yg)("li",{parentName:"ol"},"Open the ",(0,o.yg)("inlineCode",{parentName:"li"},"Launch")," link for the builded image."))),(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("p",{parentName:"li"},"Launch and access the AWS image through the ",(0,o.yg)("strong",{parentName:"p"},"AWS management console"),", go to ",(0,o.yg)("a",{parentName:"p",href:"https://aws.amazon.com/console/"},"https://aws.amazon.com/console/")),(0,o.yg)("ol",{parentName:"li",start:11},(0,o.yg)("li",{parentName:"ol"},"The previous link will open an AWS console tab with the\n",(0,o.yg)("em",{parentName:"li"},"Launch an Instance")," wizard preset to use the builded image.\nYou need to login into the ",(0,o.yg)("em",{parentName:"li"},"AWS management console")," using an ",(0,o.yg)("em",{parentName:"li"},"AWS Account ID"),"\nallowed to access the ",(0,o.yg)("em",{parentName:"li"},"AMI Image")," you just created."),(0,o.yg)("li",{parentName:"ol"},"Select a ",(0,o.yg)("strong",{parentName:"li"},"Key pair"),", or create one if you don't have it already,\nto be able to ssh the image later."),(0,o.yg)("li",{parentName:"ol"},"Click on ",(0,o.yg)("inlineCode",{parentName:"li"},"Launch Instance")),(0,o.yg)("li",{parentName:"ol"},"Connect to instance using an ssh client"),(0,o.yg)("li",{parentName:"ol"},"Add the previously created COPR repo to the list of available dnf repositories."),(0,o.yg)("li",{parentName:"ol"},"Install the package you have created at step number 4."),(0,o.yg)("li",{parentName:"ol"},"Now you are ready to test your code in a real cloud image.")))),(0,o.yg)("p",null,"For every new pull request you want to test directly in a cloud image you have to repeat\nsteps 4-16 or automate them through Packit!"),(0,o.yg)("h1",{id:"automate-the-steps"},"Automate the steps"),(0,o.yg)("h2",{id:"install-packit"},"Install Packit"),(0,o.yg)("p",null,"Installing Packit is pretty straightforward."),(0,o.yg)("ol",null,(0,o.yg)("li",{parentName:"ol"},"Create a valid ",(0,o.yg)("a",{parentName:"li",href:"https://fedoraproject.org/wiki/Account_System"},"Fedora Account System (FAS)"),"\naccount (if you don't already have one).\nWhy do you need it? After these few steps you will start building (and potentially shipping)\nFedora packages through the ",(0,o.yg)("a",{parentName:"li",href:"https://copr.fedorainfracloud.org/"},"COPR service")," and we need you to agree with the Fedora license."),(0,o.yg)("li",{parentName:"ol"},"Install our GitHub application on ",(0,o.yg)("a",{parentName:"li",href:"https://github.com/marketplace/packit-as-a-service"},"GitHub Marketplace"),",\nor ",(0,o.yg)("a",{parentName:"li",href:"https://packit.dev/docs/guide/#how-to-set-up-packit-on-gitlab"},"configure a webhook")," on GitLab\n(depending on where your project lives)."),(0,o.yg)("li",{parentName:"ol"},"Make Packit ",(0,o.yg)("a",{parentName:"li",href:"https://packit.dev/docs/guide/#2-approval"},"approve your FAS username"),";\non Github the approval process is automated and for Gitlab you have to contact us.")),(0,o.yg)("p",null,"Now you are ready to automate the process as described below."),(0,o.yg)("h2",{id:"setup-packit"},"Setup Packit"),(0,o.yg)("p",null,"Create a ",(0,o.yg)("inlineCode",{parentName:"p"},".packit.yaml")," configuration file in your pull request."),(0,o.yg)("p",null,"But just the first time! After your pull request has been merged, Packit will take the ",(0,o.yg)("inlineCode",{parentName:"p"},".packit.yaml")," file from the target ",(0,o.yg)("em",{parentName:"p"},"main branch"),"."),(0,o.yg)("p",null,"The configuration file will look like the following:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre"},"---\n\njobs:\n- job: copr_build\n  trigger: pull_request\n  targets:\n  - fedora-all\n\n- job: vm_image_build\n  trigger: pull_request\n  image_request:\n    architecture: x86_64\n    image_type: aws\n    upload_request:\n      type: aws\n      options:\n        share_with_accounts:\n        - < shared-aws-account-id >\n  image_distribution: fedora-39\n  copr_chroot: fedora-39-x86_64\n  image_customizations:\n    packages: [hello-world]\n")),(0,o.yg)("h3",{id:"copr_build-job"},"copr_build job"),(0,o.yg)("p",null,"The first job tells Packit service to build an RPM package, for the Fedora release you want,\nin this example all the active fedora releases, and to add your pull request changes to the package."),(0,o.yg)("p",null,"To further customize the COPR builds made by Packit you may want to give a look at this\n",(0,o.yg)("a",{parentName:"p",href:"https://packit.dev/docs/configuration/upstream/copr_build"},"guide"),"."),(0,o.yg)("h3",{id:"vm_image_build-job"},"vm_image_build job"),(0,o.yg)("p",null,"The second job tells Packit how to configure the Builder Image service."),(0,o.yg)("p",null,"The first two lines of this job are still meant for Packit;\nthey allow Packit to react to your pull request comment ",(0,o.yg)("inlineCode",{parentName:"p"},"/packit vm-image-build"),".\nPackit does not build a VM image automatically, as it does when it builds a COPR package,\nto save you from no wanted costs."),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre"},"- job: vm_image_build\ntrigger: pull_request\n")),(0,o.yg)("p",null,"The other lines are meant to customize the Image Builder behaviour."),(0,o.yg)("p",null,"You are asking to build an ",(0,o.yg)("em",{parentName:"p"},"AWS")," image, with a ",(0,o.yg)("em",{parentName:"p"},"fedora-39")," distribution,\nfor the ",(0,o.yg)("em",{parentName:"p"},"x86_64")," architecture and you want to share it with the listed\n",(0,o.yg)("em",{parentName:"p"},"AWS Account IDs"),"."),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre"},"image_request:\n  architecture: x86_64\n  image_type: aws\n  upload_request:\n    type: aws\n    options:\n      share_with_accounts:\n      - < shared-aws-account-id >\nimage_distribution: fedora-39\n")),(0,o.yg)("p",null,"You don't want to manually install the COPR package into the image,\nfor this reason you ask the Image Builder to install it (",(0,o.yg)("em",{parentName:"p"},"hello-world"),")."),(0,o.yg)("p",null,"You tell Image Builder to take it from the COPR chroot ",(0,o.yg)("em",{parentName:"p"},"fedora-39-x86_64"),",\nand you don't need to create or specify a COPR project because it has\nbeen automatically created by Packit for you."),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre"},"copr_chroot: fedora-39-x86_64\nimage_customizations:\n  packages: [hello-world]\n")),(0,o.yg)("h2",{id:"create-comment-and-test-a-pull-request"},"Create, comment and test a pull request!"),(0,o.yg)("p",null,"Create a pull request, mine will show you the ",(0,o.yg)("strong",{parentName:"p"},"world")," word in green \ud83c\udf3f."),(0,o.yg)("p",null,"You are ready to go, just comment your pull request with"),(0,o.yg)("p",null,(0,o.yg)("inlineCode",{parentName:"p"},"/packit vm-image-build")),(0,o.yg)("p",null,"and the image will be built and customized for you."),(0,o.yg)("p",null,"Look for the check named ",(0,o.yg)("strong",{parentName:"p"},"vm-image-build-fedora-39-x86_64"),"\nand wait for it to finish."),(0,o.yg)("p",null,(0,o.yg)("img",{alt:"Wait for check vm-image-build-fedora-39-x86_64 to finish",src:t(10883).A,width:"512",height:"194"})),(0,o.yg)("p",null,"Open its details and you will find the link\nto the AWS image."),(0,o.yg)("p",null,(0,o.yg)("img",{alt:"The check details have a link to the AWS image",src:t(82033).A,width:"512",height:"198"})),(0,o.yg)("p",null,"Open the AWS link (you need to be already logged in) and\nsee the details of your image ready to be launched."),(0,o.yg)("p",null,(0,o.yg)("img",{alt:"The AWS image details",src:t(16161).A,width:"512",height:"246"})),(0,o.yg)("p",null,"Launch your image instance and connect to it."),(0,o.yg)("p",null,(0,o.yg)("img",{alt:"Connect to instance details",src:t(75565).A,width:"512",height:"393"})),(0,o.yg)("p",null,"Test it!"),(0,o.yg)("p",null,(0,o.yg)("img",{alt:"Test it!",src:t(50546).A,width:"495",height:"94"})))}g.isMDXComponent=!0},50546:(e,a,t)=>{t.d(a,{A:()=>n});const n=t.p+"assets/images/hello-world-809c7da500a4aca0a1d5b7fbdd3ea1fc.png"},75565:(e,a,t)=>{t.d(a,{A:()=>n});const n=t.p+"assets/images/connect-to-instance-0f2ae4856b17566477e3e4e29074075f.png"},82033:(e,a,t)=>{t.d(a,{A:()=>n});const n=t.p+"assets/images/link_to_aws_image-16f87362483365f8530c80041de39ada.png"}}]);