"use strict";(self.webpackChunkpackit_dev=self.webpackChunkpackit_dev||[]).push([[5189],{3905:(e,t,a)=>{a.d(t,{Zo:()=>s,kt:()=>u});var o=a(67294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,o)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function p(e,t){if(null==e)return{};var a,o,n=function(e,t){if(null==e)return{};var a,o,n={},i=Object.keys(e);for(o=0;o<i.length;o++)a=i[o],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)a=i[o],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=o.createContext({}),c=function(e){var t=o.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},s=function(e){var t=c(e.components);return o.createElement(l.Provider,{value:t},e.children)},m="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},k=o.forwardRef((function(e,t){var a=e.components,n=e.mdxType,i=e.originalType,l=e.parentName,s=p(e,["components","mdxType","originalType","parentName"]),m=c(a),k=n,u=m["".concat(l,".").concat(k)]||m[k]||h[k]||i;return a?o.createElement(u,r(r({ref:t},s),{},{components:a})):o.createElement(u,r({ref:t},s))}));function u(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=a.length,r=new Array(i);r[0]=k;var p={};for(var l in t)hasOwnProperty.call(t,l)&&(p[l]=t[l]);p.originalType=e,p[m]="string"==typeof e?e:n,r[1]=p;for(var c=2;c<i;c++)r[c]=a[c];return o.createElement.apply(null,r)}return o.createElement.apply(null,a)}k.displayName="MDXCreateElement"},75392:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>i,metadata:()=>p,toc:()=>c});var o=a(87462),n=(a(67294),a(3905));const i={title:"Packit's pre-commit hooks",date:new Date("2023-05-16T11:00:00.000Z"),authors:"jpopelka",tags:["workflow"]},r=void 0,p={permalink:"/posts/pre-commit-hooks",editUrl:"https://github.com/packit/packit.dev/tree/main/posts/pre-commit-hooks/index.md",source:"@site/posts/pre-commit-hooks/index.md",title:"Packit's pre-commit hooks",description:"pre-commit is a wonderful tool that saves you",date:"2023-05-16T11:00:00.000Z",formattedDate:"May 16, 2023",tags:[{label:"workflow",permalink:"/posts/tags/workflow"}],readingTime:2.165,hasTruncateMarker:!0,authors:[{name:"Ji\u0159\xed Popelka",email:"jpopelka@redhat.com",url:"https://github.com/jpopelka",imageURL:"https://github.com/jpopelka.png",key:"jpopelka"}],frontMatter:{title:"Packit's pre-commit hooks",date:"2023-05-16T11:00:00.000Z",authors:"jpopelka",tags:["workflow"]},prevItem:{title:"Handling of Release field in propose_downstream job",permalink:"/posts/release-field-handling"},nextItem:{title:"2022 for Packit",permalink:"/posts/2022-features"}},l={authorsImageUrls:[void 0]},c=[{value:"Our pre-commit hooks",id:"our-pre-commit-hooks",level:2},{value:"check-rebase",id:"check-rebase",level:3},{value:"validate-config",id:"validate-config",level:3},{value:"validate-config-in-container",id:"validate-config-in-container",level:4},{value:"validate-config",id:"validate-config-1",level:4},{value:"But why the hook doesn&#39;t install <code>packit</code> itself?",id:"but-why-the-hook-doesnt-install-packit-itself",level:5}],s={toc:c},m="wrapper";function h(e){let{components:t,...a}=e;return(0,n.kt)(m,(0,o.Z)({},s,a,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://pre-commit.com"},"pre-commit")," is a wonderful tool that saves you\na lot of time by automatically checking your changes before you\ncommit and/or push them out."),(0,n.kt)("p",null,"For example, in our ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/packit/packit/blob/main/.pre-commit-config.yaml"},"packit repo"),"\nwe run various hooks upon each commit:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/psf/black"},"Black (Python code formatter)"),","),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/prettier/prettier"},"Prettier (code formatter)"),","),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://pypi.org/project/flake8"},"Flake8 (Python source code checker)"),","),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/python/mypy"},"Mypy (static type checker for Python)"),","),(0,n.kt)("li",{parentName:"ul"},"and ",(0,n.kt)("a",{parentName:"li",href:"https://github.com/pre-commit/pre-commit-hooks"},"several other pre-commit hooks"),".")),(0,n.kt)("h2",{id:"our-pre-commit-hooks"},"Our pre-commit hooks"),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://github.com/packit/pre-commit-hooks"},"We also have a few hooks"),"\nwhich we've created and which you might find useful as well."),(0,n.kt)("h3",{id:"check-rebase"},"check-rebase"),(0,n.kt)("p",null,"We in Packit love linear git history.\nThis hook checks whether your branch is up-to-date with the upstream,\nand we use it to know when it's time to rebase changes before we push them."),(0,n.kt)("p",null,"To try, add this to your ",(0,n.kt)("inlineCode",{parentName:"p"},".pre-commit-config.yaml")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"- repo: https://github.com/packit/pre-commit-hooks\n  rev: v1.2.0\n  hooks:\n    - id: check-rebase\n      args: [upstream_url]\n")),(0,n.kt)("h3",{id:"validate-config"},"validate-config"),(0,n.kt)("p",null,"Packit uses a ",(0,n.kt)("a",{parentName:"p",href:"https://packit.dev/docs/configuration"},"YAML configuration file"),"\nin an upstream repository.\nWe have a ",(0,n.kt)("a",{parentName:"p",href:"https://packit.dev/docs/cli/validate-config"},"packit validate-config")," command\nto check it, but it's easy to forget (to run it) and notice a typo after you\ncommitted and pushed the changes and waited for some time for Packit to tell you\nthat in a PR."),(0,n.kt)("p",null,"It's much faster to catch the problem before committing and/or pushing the changes."),(0,n.kt)("h4",{id:"validate-config-in-container"},"validate-config-in-container"),(0,n.kt)("p",null,"This hook runs (only if there's been a change in the ",(0,n.kt)("inlineCode",{parentName:"p"},".packit.yaml"),")\n",(0,n.kt)("inlineCode",{parentName:"p"},"packit")," in a container (from ",(0,n.kt)("a",{parentName:"p",href:"https://quay.io/repository/packit/packit"},"our image"),"),\nmounts your sources inside and runs the ",(0,n.kt)("inlineCode",{parentName:"p"},"packit validate-config"),"."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"- repo: https://github.com/packit/pre-commit-hooks\n  rev: v1.2.0\n  hooks:\n    - id: validate-config-in-container\n")),(0,n.kt)("p",null,"It requires docker/podman, which can be a problem for example in a\n",(0,n.kt)("a",{parentName:"p",href:"https://github.com/pre-commit-ci/issues/issues/11"},"CI"),"."),(0,n.kt)("h4",{id:"validate-config-1"},"validate-config"),(0,n.kt)("p",null,"Another option is a hook which runs the ",(0,n.kt)("inlineCode",{parentName:"p"},"packit")," binary directly installed\non the machine. If there's no ",(0,n.kt)("inlineCode",{parentName:"p"},"packit"),", the hook passes to not break\nfor example your CI where ",(0,n.kt)("inlineCode",{parentName:"p"},"packit")," is most likely not installed."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},"- repo: https://github.com/packit/pre-commit-hooks\n  rev: v1.2.0\n  hooks:\n    - id: validate-config\n")),(0,n.kt)("h5",{id:"but-why-the-hook-doesnt-install-packit-itself"},"But why the hook doesn't install ",(0,n.kt)("inlineCode",{parentName:"h5"},"packit")," itself?"),(0,n.kt)("p",null,"Right, typically, when you run a pre-commit hook for the first time,\nit installs everything it needs.\nLike in case of Python, pre-commit ",(0,n.kt)("inlineCode",{parentName:"p"},"pip")," installs all the dependencies."),(0,n.kt)("p",null,"The problem in our case is that ",(0,n.kt)("inlineCode",{parentName:"p"},"packit")," has a lot of dependencies and\nsome of them (if missing) are compiled from source when you try to\n",(0,n.kt)("a",{parentName:"p",href:"https://packit.dev/docs/cli/#from-pypi"},"pip install packit"),".\nThat needs ",(0,n.kt)("inlineCode",{parentName:"p"},"gcc")," and additional ",(0,n.kt)("inlineCode",{parentName:"p"},"devel")," packages\nto be installed on the machine prior to running the hook for the first time.\nThat would make the hook usage very user unfriendly, leaving aside that\nsometimes (in a CI) you don't have access to the machine to install them\nprior to running the hooks."))}h.isMDXComponent=!0}}]);