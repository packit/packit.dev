"use strict";(self.webpackChunkpackit_dev=self.webpackChunkpackit_dev||[]).push([[22452],{15680:(e,t,a)=>{a.d(t,{xA:()=>m,yg:()=>h});var l=a(96540);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);t&&(l=l.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,l)}return a}function n(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,l,i=function(e,t){if(null==e)return{};var a,l,i={},r=Object.keys(e);for(l=0;l<r.length;l++)a=r[l],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(l=0;l<r.length;l++)a=r[l],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var o=l.createContext({}),p=function(e){var t=l.useContext(o),a=t;return e&&(a="function"==typeof e?e(t):n(n({},t),e)),a},m=function(e){var t=p(e.components);return l.createElement(o.Provider,{value:t},e.children)},g="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return l.createElement(l.Fragment,{},t)}},c=l.forwardRef((function(e,t){var a=e.components,i=e.mdxType,r=e.originalType,o=e.parentName,m=s(e,["components","mdxType","originalType","parentName"]),g=p(a),c=i,h=g["".concat(o,".").concat(c)]||g[c]||u[c]||r;return a?l.createElement(h,n(n({ref:t},m),{},{components:a})):l.createElement(h,n({ref:t},m))}));function h(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=a.length,n=new Array(r);n[0]=c;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s[g]="string"==typeof e?e:i,n[1]=s;for(var p=2;p<r;p++)n[p]=a[p];return l.createElement.apply(null,n)}return l.createElement.apply(null,a)}c.displayName="MDXCreateElement"},60046:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>o,contentTitle:()=>n,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>p});var l=a(58168),i=(a(96540),a(15680));const r={title:"Splitting source-git and upstream",authors:"flachman"},n=void 0,s={unversionedId:"source-git/split-the-stream",id:"source-git/split-the-stream",title:"Splitting source-git and upstream",description:"Some ideas, possibilities, pros and cons of moving out the source-git related work.",source:"@site/research/source-git/split-the-stream.md",sourceDirName:"source-git",slug:"/source-git/split-the-stream",permalink:"/research/source-git/split-the-stream",draft:!1,editUrl:"https://github.com/packit/research/tree/main/research/source-git/split-the-stream.md",tags:[],version:"current",frontMatter:{title:"Splitting source-git and upstream",authors:"flachman"},sidebar:"autogenerated",previous:{title:"Source-git on Pagure",permalink:"/research/source-git/on-pagure"},next:{title:"Verifying the sync status of source-git and dist-git repos",permalink:"/research/source-git/sync-status"}},o={},p=[{value:"What does the source-git workflow mean?",id:"what-does-the-source-git-workflow-mean",level:2},{value:"Key questions:",id:"key-questions",level:2},{value:"Split",id:"split",level:2},{value:"0. no split",id:"0-no-split",level:3},{value:"1. same codebase, new deployment",id:"1-same-codebase-new-deployment",level:3},{value:"2. separate workers",id:"2-separate-workers",level:3},{value:"3. split the packit-service repo and build upstream/centos-stream workers",id:"3-split-the-packit-service-repo-and-build-upstreamcentos-stream-workers",level:3},{value:"4. fork and improve",id:"4-fork-and-improve",level:3},{value:"5. separate project from scratch",id:"5-separate-project-from-scratch",level:3},{value:"Dashboard",id:"dashboard",level:3},{value:"Database",id:"database",level:3},{value:"One schema for all",id:"one-schema-for-all",level:4},{value:"Independent schemas",id:"independent-schemas",level:4},{value:"Multiple alembic branches",id:"multiple-alembic-branches",level:4},{value:"Multiple alembic bases",id:"multiple-alembic-bases",level:4},{value:"Linking of the merge-requests",id:"linking-of-the-merge-requests",level:2},{value:"Merge trains",id:"merge-trains",level:2},{value:"Multi-project pipelines",id:"multi-project-pipelines",level:2},{value:"Parent-child pipelines",id:"parent-child-pipelines",level:2},{value:"Pipelines API",id:"pipelines-api",level:2},{value:"Commit status",id:"commit-status",level:2},{value:"CI results",id:"ci-results",level:2},{value:"Answers to Key questions",id:"answers-to-key-questions",level:2},{value:"The plan",id:"the-plan",level:2}],m={toc:p},g="wrapper";function u(e){let{components:t,...a}=e;return(0,i.yg)(g,(0,l.A)({},m,a,{components:t,mdxType:"MDXLayout"}),(0,i.yg)("p",null,"Some ideas, possibilities, pros and cons of moving out the source-git related work."),(0,i.yg)("h2",{id:"what-does-the-source-git-workflow-mean"},"What does the source-git workflow mean?"),(0,i.yg)("p",null,"Must have:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"If user creates a merge-request on the source-git repository:",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"Create a matching merge-request to the dist-git repository."),(0,i.yg)("li",{parentName:"ul"},"Sync the CI results from the dist-git merge-request to the source-git merge-request."))),(0,i.yg)("li",{parentName:"ul"},"If the dist-git is updated, update the source-git repository by opening a PR."),(0,i.yg)("li",{parentName:"ul"},"User is able to convert source-git change to the dist-git change locally via CLI.")),(0,i.yg)("p",null,"Should have:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"If the source-git merge-request is updated, update the dist-git merge-request."),(0,i.yg)("li",{parentName:"ul"},"If the source-git merge-request is closed, close the dist-git merge-request.")),(0,i.yg)("p",null,"Could have:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"User is able to re-trigger the dist-git CI from the source-git merge-request."),(0,i.yg)("li",{parentName:"ul"},"User is able to re-create the dist-git MR from the source-git merge-request.")),(0,i.yg)("h2",{id:"key-questions"},"Key questions:"),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},"Should we start developing a new service or modify the existing packit-service to be able to deploy only with a gitlab-endpoint?"),(0,i.yg)("li",{parentName:"ol"},"How to link merge requests in the src namespace to the ones in the rpms namespace using the GitLab API? This should be bidirectional."),(0,i.yg)("li",{parentName:"ol"},"Check the GitLab API to learn more about working with merge-trains and pipelines, in order to support the UX for merging source-git MRs (see the doc linked bellow)."),(0,i.yg)("li",{parentName:"ol"},"How are CI results going to be displayed in dist-git MRs? We wan't to know this so that we can think about ways to take those results and display them for contributors on the source-git MRs.")),(0,i.yg)("h2",{id:"split"},"Split"),(0,i.yg)("p",null,"We have multiple options:"),(0,i.yg)("h3",{id:"0-no-split"},"0. no split"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"No extra cost of two deployments and two codebases."),(0,i.yg)("li",{parentName:"ul"},"New jobs will be implemented as new handlers."),(0,i.yg)("li",{parentName:"ul"},"We don't have support for multiple identities for one forge.",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"Not hard to do but requires some work."))),(0,i.yg)("li",{parentName:"ul"},"Fedora-source-git friendly: easy combination of events (different for Fedora and Stream)\nand handlers (=implementation, can be shared).")),(0,i.yg)("h3",{id:"1-same-codebase-new-deployment"},"1. same codebase, new deployment"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"No extra cost of maintenance of two codebases."),(0,i.yg)("li",{parentName:"ul"},"New jobs are implemented as new handlers."),(0,i.yg)("li",{parentName:"ul"},"Different identities can be used in one git forge (=gitlab.com)."),(0,i.yg)("li",{parentName:"ul"},"Resources can be tweaked separately."),(0,i.yg)("li",{parentName:"ul"},"Fedora-source-git friendly: easy combination of events (different for Fedora and Stream)\nand handlers (=implementation, can be shared).")),(0,i.yg)("h3",{id:"2-separate-workers"},"2. separate workers"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"New jobs are implemented as new handlers in a separate repository."),(0,i.yg)("li",{parentName:"ul"},"The centos-stream related code is in one place, based-on the packit-service code."),(0,i.yg)("li",{parentName:"ul"},"We can use same or a separate deployment.\n(Fedora-source-git can be separated or with Stream.)")),(0,i.yg)("h3",{id:"3-split-the-packit-service-repo-and-build-upstreamcentos-stream-workers"},"3. split the packit-service repo and build upstream/centos-stream workers"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"One repo with the scheduler.\nTwo repositories with the worker(=handlers) definition: one for the upstream, one for the stream."),(0,i.yg)("li",{parentName:"ul"},"Requires more work."),(0,i.yg)("li",{parentName:"ul"},"Can lead to a cleaner architecture. Something we were discussing for some time.",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"The centos-stream related code is in one place,\nupstream code is in one place and\nthe shared code is in one place."))),(0,i.yg)("li",{parentName:"ul"},"Another dependency in the chain.",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"It's sometimes hard to work on the functionality that goes across multiple git projects."))),(0,i.yg)("li",{parentName:"ul"},"We can use same or a separate deployment.\n(Fedora-source-git can be separated or with Stream.)")),(0,i.yg)("h3",{id:"4-fork-and-improve"},"4. fork and improve"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"The benefits of the current service code can be preserved."),(0,i.yg)("li",{parentName:"ul"},"The non-relevant/bad code can be removed."),(0,i.yg)("li",{parentName:"ul"},"More time needed for development."),(0,i.yg)("li",{parentName:"ul"},"Improvements relevant for both are hard to sync."),(0,i.yg)("li",{parentName:"ul"},"More time needed for maintenance.")),(0,i.yg)("h3",{id:"5-separate-project-from-scratch"},"5. separate project from scratch"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"The new service can be more lightweight and efficient."),(0,i.yg)("li",{parentName:"ul"},"We can iterate on the prototype more quickly."),(0,i.yg)("li",{parentName:"ul"},"We can get rid of the old bad staff in the packit-service."),(0,i.yg)("li",{parentName:"ul"},"We can go through the same pain we've already gone through."),(0,i.yg)("li",{parentName:"ul"},"We need to maintain two separate projects. (We need more people or reduce the productivity.)"),(0,i.yg)("li",{parentName:"ul"},"We are not motivated to improve the current projects."),(0,i.yg)("li",{parentName:"ul"},"To share the code between the upstream and source project, we need to create some shared libraries.",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"Can lead to 3. and/or having another project on our dependency chain.")))),(0,i.yg)("h3",{id:"dashboard"},"Dashboard"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"For the current goals, there is no need for having a dashboard.",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"GitLab is our interface, and we can link the same result links as the CI in dist-git.")))),(0,i.yg)("h3",{id:"database"},"Database"),(0,i.yg)("p",null,"What are the differences in the schema?"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Event related models can be shared (",(0,i.yg)("inlineCode",{parentName:"li"},"GitProject"),", ",(0,i.yg)("inlineCode",{parentName:"li"},"JobTriggerModel"),", ",(0,i.yg)("inlineCode",{parentName:"li"},"RunModel"),", PullRequestModel`, ...)."),(0,i.yg)("li",{parentName:"ul"},"Result models are probably not necessary (",(0,i.yg)("inlineCode",{parentName:"li"},"SRPMBuildModel"),", ",(0,i.yg)("inlineCode",{parentName:"li"},"CoprBuildModel"),", ...)."),(0,i.yg)("li",{parentName:"ul"},"Allow/deny list can be preserved."),(0,i.yg)("li",{parentName:"ul"},"Models for the setup procedure aren't necessary for stream (",(0,i.yg)("inlineCode",{parentName:"li"},"InstallationModel"),", ",(0,i.yg)("inlineCode",{parentName:"li"},"ProjectAuthenticationIssueModel"),")."),(0,i.yg)("li",{parentName:"ul"},"Connection between source-git and dist-git MRs can be done by creating a new join table."),(0,i.yg)("li",{parentName:"ul"},"If we need to track the results, we need to create a new model for that.")),(0,i.yg)("p",null,"We have multiple ways how we can manage database schema after the split:"),(0,i.yg)("h4",{id:"one-schema-for-all"},"One schema for all"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"One schema that works for all use-cases."),(0,i.yg)("li",{parentName:"ul"},"The schema is defined in one place."),(0,i.yg)("li",{parentName:"ul"},"Databases can contain unused tables."),(0,i.yg)("li",{parentName:"ul"},"Schema can be more complicated.")),(0,i.yg)("h4",{id:"independent-schemas"},"Independent schemas"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Each schema fits the use-case."),(0,i.yg)("li",{parentName:"ul"},"Common changes are harder to share.")),(0,i.yg)("h4",{id:"multiple-alembic-branches"},"Multiple alembic branches"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://alembic.sqlalchemy.org/en/latest/branches.html"},"https://alembic.sqlalchemy.org/en/latest/branches.html")),(0,i.yg)("li",{parentName:"ul"},"Each use-case has its own alembic branch."),(0,i.yg)("li",{parentName:"ul"},"The definition is in one place."),(0,i.yg)("li",{parentName:"ul"},"Does not help with sharing of changes. (There is only merge and no rebase available.)")),(0,i.yg)("h4",{id:"multiple-alembic-bases"},"Multiple alembic bases"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://alembic.sqlalchemy.org/en/latest/branches.html#working-with-multiple-bases"},"https://alembic.sqlalchemy.org/en/latest/branches.html#working-with-multiple-bases")),(0,i.yg)("li",{parentName:"ul"},"Multiple independent alembic migration paths. (We work on multiple branches in parallel.)"),(0,i.yg)("li",{parentName:"ul"},"Different base can be located in a different location.",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"There can be one shared schema and each use-case (upstream/CentOS-stream/?Fedora) can have a second one."))),(0,i.yg)("li",{parentName:"ul"},"Ideally, bases are independent, but it is possible to\n",(0,i.yg)("a",{parentName:"li",href:"https://alembic.sqlalchemy.org/en/latest/branches.html#branch-dependencies"},"specify dependencies"),"\nbetween revisions.")),(0,i.yg)("h2",{id:"linking-of-the-merge-requests"},"Linking of the merge-requests"),(0,i.yg)("p",null,"We have two goals:"),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},"User can easily find the related merge request on the web UI. (In both ways.)"),(0,i.yg)("li",{parentName:"ol"},"We can get the related merge request from the service.")),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"We can set the dependent merge-requests across multiple projects\n(e.g. ",(0,i.yg)("a",{parentName:"li",href:"https://gitlab.com/lachmanfrantisek/kernel-ark/-/merge_requests/1"},"https://gitlab.com/lachmanfrantisek/kernel-ark/-/merge_requests/1"),")",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"The API is not implemented: ",(0,i.yg)("a",{parentName:"li",href:"https://gitlab.com/gitlab-org/gitlab/-/issues/12551"},"https://gitlab.com/gitlab-org/gitlab/-/issues/12551")))),(0,i.yg)("li",{parentName:"ul"},"Mentioning the other merge-request is always a possibility.\n(Mapping would be problematic.)"),(0,i.yg)("li",{parentName:"ul"},"For the purpose of the service, we can save the pairs to the database.")),(0,i.yg)("p",null,"Some related GitLab issues:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://gitlab.com/gitlab-org/gitlab/-/issues/300042"},"Rearchitect MR widget mergeability logic")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://gitlab.com/gitlab-org/gitlab/-/issues/324381"},"Rearchitect / Refactor MR Widget [Discovery]"))),(0,i.yg)("h2",{id:"merge-trains"},"Merge trains"),(0,i.yg)("p",null,"Allow merging multiple MRs in one target branch safely:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"We put MRs to the queue."),(0,i.yg)("li",{parentName:"ul"},"For each MR, we run pipeline on the code containing this MR and all before."),(0,i.yg)("li",{parentName:"ul"},"Pipelines are run in parallel to safe time.")),(0,i.yg)("p",null,"Conclusion:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"This feature is something like zuul's gating pipeline with auto-rebase done in parallel."),(0,i.yg)("li",{parentName:"ul"},"It's not meant for cross-project MRs => not useful for us.")),(0,i.yg)("p",null,"Sources:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://docs.gitlab.com/ee/ci/merge_request_pipelines/pipelines_for_merged_results/merge_trains/"},"https://docs.gitlab.com/ee/ci/merge_request_pipelines/pipelines_for_merged_results/merge_trains/")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://about.gitlab.com/blog/2020/12/14/merge-trains-explained/"},"https://about.gitlab.com/blog/2020/12/14/merge-trains-explained/")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://about.gitlab.com/blog/2020/01/30/all-aboard-merge-trains/"},"https://about.gitlab.com/blog/2020/01/30/all-aboard-merge-trains/"))),(0,i.yg)("h2",{id:"multi-project-pipelines"},"Multi-project pipelines"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://docs.gitlab.com/ee/ci/multi_project_pipelines.html"},"https://docs.gitlab.com/ee/ci/multi_project_pipelines.html")),(0,i.yg)("li",{parentName:"ul"},"Pipeline to trigger a pipeline in a different project\n(e.g. generate documentation in a different repo once code change is merged).")),(0,i.yg)("p",null,"Conclusion:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Don't give us much benefits. (We need to work with dynamic reference on the second repository.)")),(0,i.yg)("h2",{id:"parent-child-pipelines"},"Parent-child pipelines"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://docs.gitlab.com/ee/ci/parent_child_pipelines.html"},"https://docs.gitlab.com/ee/ci/parent_child_pipelines.html")),(0,i.yg)("li",{parentName:"ul"},"Pipeline can trigger a set of concurrently running child pipelines within the same project.",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"Child jobs are not dependant on the state of non-related jobs on parent pipeline."),(0,i.yg)("li",{parentName:"ul"},"Configuration can be split into multiple smaller easy-to-understand parts."),(0,i.yg)("li",{parentName:"ul"},"Avoids name collisions. (Comparing to pure ",(0,i.yg)("inlineCode",{parentName:"li"},"import"),".)")))),(0,i.yg)("h2",{id:"pipelines-api"},"Pipelines API"),(0,i.yg)("p",null,"Looks like pipelines need to be defined beforehand. We can manipulate only defined ones."),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"REST API: ",(0,i.yg)("a",{parentName:"li",href:"https://docs.gitlab.com/ee/api/pipelines.html"},"https://docs.gitlab.com/ee/api/pipelines.html")),(0,i.yg)("li",{parentName:"ul"},"Python API: ",(0,i.yg)("a",{parentName:"li",href:"https://python-gitlab.readthedocs.io/en/stable/gl_objects/pipelines_and_jobs.html"},"https://python-gitlab.readthedocs.io/en/stable/gl_objects/pipelines_and_jobs.html"))),(0,i.yg)("blockquote",null,(0,i.yg)("p",{parentName:"blockquote"},"Pipelines for merge requests are configured.\nA detached pipeline runs in the context of the merge request, and not against the merged result.\nLearn more in the documentation for Pipelines for Merged Results.")),(0,i.yg)("p",null,"To support this we can define the pipelines, wait for and get the result from Packit API.\n(Goes against the current Packit workflow.)"),(0,i.yg)("p",null,"We can also have a custom gitlab runner running our implementation in our infrastructure."),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Results are shown as pipelines."),(0,i.yg)("li",{parentName:"ul"},"Completely independent to our celery-base workflow."),(0,i.yg)("li",{parentName:"ul"},"A funny example: ",(0,i.yg)("a",{parentName:"li",href:"https://about.gitlab.com/blog/2018/06/29/introducing-auto-breakfast-from-gitlab/"},"https://about.gitlab.com/blog/2018/06/29/introducing-auto-breakfast-from-gitlab/"))),(0,i.yg)("p",null,"Potentially, we can use ",(0,i.yg)("inlineCode",{parentName:"p"},"only: - external")," when defining the pipeline and combine it with the commit statuse:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://gitlab.com/gitlab-org/gitlab/-/issues/20907#note_300399873"},"https://gitlab.com/gitlab-org/gitlab/-/issues/20907#note_300399873")),(0,i.yg)("li",{parentName:"ul"},"But I can't make this approach work.")),(0,i.yg)("p",null,"Some related GitLab issues:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://gitlab.com/groups/gitlab-org/-/epics/5701"},"EPIC: Customer custom MR widgets/Checks"),(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://gitlab.com/gitlab-org/gitlab/-/issues/22187"},"Introduce Checks API")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://gitlab.com/gitlab-org/gitlab/-/issues/7669"},"Provide an API for generic section in the Merge Request widget")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://gitlab.com/gitlab-org/gitlab/-/issues/23759"},"Redesign external commit status")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://gitlab.com/gitlab-org/gitlab/-/issues/23282"},"Markdown CI View / MR Widget")))),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://gitlab.com/gitlab-org/gitlab/-/issues/15018"},"Show arbitrary build results (closed)")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://gitlab.com/gitlab-org/gitlab/-/issues/22985"},"Custom merge widget blocks"))),(0,i.yg)("h2",{id:"commit-status"},"Commit status"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Converted to ",(0,i.yg)("inlineCode",{parentName:"li"},"external")," jobs of ",(0,i.yg)("inlineCode",{parentName:"li"},"detached")," pipeline."),(0,i.yg)("li",{parentName:"ul"},"Only one stage (=column) is possible in the pipeline chart: ",(0,i.yg)("a",{parentName:"li",href:"https://gitlab.com/gitlab-org/gitlab/-/issues/19177"},"https://gitlab.com/gitlab-org/gitlab/-/issues/19177")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://docs.gitlab.com/ee/api/commits.html#commit-status"},"https://docs.gitlab.com/ee/api/commits.html#commit-status")),(0,i.yg)("li",{parentName:"ul"},"Python API: ",(0,i.yg)("a",{parentName:"li",href:"https://python-gitlab.readthedocs.io/en/stable/gl_objects/commits.html#commit-status"},"https://python-gitlab.readthedocs.io/en/stable/gl_objects/commits.html#commit-status")),(0,i.yg)("li",{parentName:"ul"},"OGR: ",(0,i.yg)("a",{parentName:"li",href:"https://packit.github.io/ogr/services/gitlab/flag.html"},"https://packit.github.io/ogr/services/gitlab/flag.html"))),(0,i.yg)("h2",{id:"ci-results"},"CI results"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Currently, the CI results are shown as pipelines."),(0,i.yg)("li",{parentName:"ul"},"Example: ",(0,i.yg)("a",{parentName:"li",href:"https://gitlab.com/redhat/centos-stream/rpms/hdparm/-/merge_requests/1/pipelines"},"https://gitlab.com/redhat/centos-stream/rpms/hdparm/-/merge_requests/1/pipelines")),(0,i.yg)("li",{parentName:"ul"},"There is a Python API for pipelines: ",(0,i.yg)("a",{parentName:"li",href:"https://python-gitlab.readthedocs.io/en/stable/gl_objects/pipelines_and_jobs.html"},"https://python-gitlab.readthedocs.io/en/stable/gl_objects/pipelines_and_jobs.html"),(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"(No OGR support yet: ",(0,i.yg)("a",{parentName:"li",href:"https://github.com/packit/ogr/issues/420"},"https://github.com/packit/ogr/issues/420"),")")))),(0,i.yg)("h2",{id:"answers-to-key-questions"},"Answers to Key questions"),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},"Should we start developing a new service or modify the existing packit-service to be able to deploy only with a gitlab-endpoint?",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"If we want to have a clean architecture, we can use version 3 with separate deployments. Version 2 can be done as a middle step."))),(0,i.yg)("li",{parentName:"ol"},"How to link merge requests in the src namespace to the ones in the rpms namespace using the GitLab API? This should be bidirectional.",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"There is only a GUI to do that. We can use comments via API."))),(0,i.yg)("li",{parentName:"ol"},"Check the GitLab API to learn more about working with merge-trains and pipelines, in order to support the UX for merging source-git MRs (see the doc linked bellow).",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"Looks like we can't use any GitLab structure to make this automatic, but can provide the UX independently."),(0,i.yg)("li",{parentName:"ul"},"We can define pipelines or use commit statuses (=detached pipelines)."))),(0,i.yg)("li",{parentName:"ol"},"How are CI results going to be displayed in dist-git MRs? We wan't to know this so that we can think about ways to take those results and display them for contributors on the source-git MRs.",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"Displayed as pipelines.")))),(0,i.yg)("h2",{id:"the-plan"},"The plan"),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},"Set up a new repository for the stream worker.",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"stream-worker"),"/",(0,i.yg)("inlineCode",{parentName:"li"},"packit-stream-worker"),"/",(0,i.yg)("inlineCode",{parentName:"li"},"source-git-worker"),"/..."),(0,i.yg)("li",{parentName:"ul"},"Build the image in quay."),(0,i.yg)("li",{parentName:"ul"},"Setup zuul and pre-commit.ci."),(0,i.yg)("li",{parentName:"ul"},"Create a ",(0,i.yg)("inlineCode",{parentName:"li"},"stable")," branch."))),(0,i.yg)("li",{parentName:"ol"},"Set up a new deployment repository for stream.",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"Create the new playbooks and share as much as possible with current workflow."),(0,i.yg)("li",{parentName:"ul"},"We will have only one deployment for stream for start."),(0,i.yg)("li",{parentName:"ul"},"Increase (=buy) the resources in openshift online."),(0,i.yg)("li",{parentName:"ul"},"Deploy the stream service to openshift online."),(0,i.yg)("li",{parentName:"ul"},"Update the script for moving ",(0,i.yg)("inlineCode",{parentName:"li"},"stable")," branches."))),(0,i.yg)("li",{parentName:"ol"},"Implement the stream worker.",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"New celery tasks are defined."),(0,i.yg)("li",{parentName:"ul"},"Implementation is done as new handlers."),(0,i.yg)("li",{parentName:"ul"},"Start with the really basic version so we can work on deployment ASAP:",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("em",{parentName:"li"},"If user creates a merge-request on the source-git repository, create a matching merge-request to the dist-git repository.")))))),(0,i.yg)("li",{parentName:"ol"},"Put the current worker away from the service.",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"packit-worker"),"/",(0,i.yg)("inlineCode",{parentName:"li"},"packit-upstream-worker"),"/..."),(0,i.yg)("li",{parentName:"ul"},"What about the ",(0,i.yg)("inlineCode",{parentName:"li"},"process_message")," task? (SPIKE card for that has been created.)",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"Do we want to share it? What about a dedicated worker just for this?"))),(0,i.yg)("li",{parentName:"ul"},"Move the build process."),(0,i.yg)("li",{parentName:"ul"},"Setup zuul and pre-commit.ci."),(0,i.yg)("li",{parentName:"ul"},"Update deployment if necessary."),(0,i.yg)("li",{parentName:"ul"},"Update the script for moving ",(0,i.yg)("inlineCode",{parentName:"li"},"stable")," branches."),(0,i.yg)("li",{parentName:"ul"},"(Can be done in parallel with other steps.)"))),(0,i.yg)("li",{parentName:"ol"},"Implement ",(0,i.yg)("em",{parentName:"li"},"Sync the CI results from the dist-git merge-request to the source-git merge-request.")),(0,i.yg)("li",{parentName:"ol"},"Implement ",(0,i.yg)("em",{parentName:"li"},"If the dist-git is updated, update the source-git repository by opening a PR.")),(0,i.yg)("li",{parentName:"ol"},"Implement ",(0,i.yg)("em",{parentName:"li"},"If the source-git merge-request is updated, update the dist-git merge-request.")),(0,i.yg)("li",{parentName:"ol"},"Implement ",(0,i.yg)("em",{parentName:"li"},"If the source-git merge-request is closed, close the dist-git merge-request."))))}u.isMDXComponent=!0}}]);