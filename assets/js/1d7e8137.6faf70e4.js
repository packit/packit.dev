"use strict";(self.webpackChunkpackit_dev=self.webpackChunkpackit_dev||[]).push([[5963],{3905:(e,t,r)=>{r.d(t,{Zo:()=>u,kt:()=>h});var o=r(67294);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,o)}return r}function a(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,o,n=function(e,t){if(null==e)return{};var r,o,n={},i=Object.keys(e);for(o=0;o<i.length;o++)r=i[o],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)r=i[o],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var s=o.createContext({}),p=function(e){var t=o.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):a(a({},t),e)),r},u=function(e){var t=p(e.components);return o.createElement(s.Provider,{value:t},e.children)},d="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},m=o.forwardRef((function(e,t){var r=e.components,n=e.mdxType,i=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=p(r),m=n,h=d["".concat(s,".").concat(m)]||d[m]||c[m]||i;return r?o.createElement(h,a(a({ref:t},u),{},{components:r})):o.createElement(h,a({ref:t},u))}));function h(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=r.length,a=new Array(i);a[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[d]="string"==typeof e?e:n,a[1]=l;for(var p=2;p<i;p++)a[p]=r[p];return o.createElement.apply(null,a)}return o.createElement.apply(null,r)}m.displayName="MDXCreateElement"},66671:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>s,contentTitle:()=>a,default:()=>c,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var o=r(87462),n=(r(67294),r(3905));const i={title:"Triggering testing farm tests with builds from other PRs (projects)",authors:"lbarczio"},a=void 0,l={unversionedId:"user-stories/tests-builds-from-more-prs",id:"user-stories/tests-builds-from-more-prs",title:"Triggering testing farm tests with builds from other PRs (projects)",description:"Use case: having 2 builds for different PRs, being able to trigger TF tests using both builds with a Packit",source:"@site/research/user-stories/tests-builds-from-more-prs.md",sourceDirName:"user-stories",slug:"/user-stories/tests-builds-from-more-prs",permalink:"/research/user-stories/tests-builds-from-more-prs",draft:!1,editUrl:"https://github.com/packit/research/tree/main/research/user-stories/tests-builds-from-more-prs.md",tags:[],version:"current",frontMatter:{title:"Triggering testing farm tests with builds from other PRs (projects)",authors:"lbarczio"},sidebar:"autogenerated",previous:{title:"Summit 2020 Demo",permalink:"/research/user-stories/summit-demo"},next:{title:"User Experience",permalink:"/research/category/user-experience"}},s={},p=[{value:"Architecture notes",id:"architecture-notes",level:2},{value:"Possible implementation",id:"possible-implementation",level:2},{value:"Requirements",id:"requirements",level:3},{value:"Implementation",id:"implementation",level:3},{value:"Another option",id:"another-option",level:4},{value:"Models",id:"models",level:3},{value:"Retriggering",id:"retriggering",level:3},{value:"Syntax of the command",id:"syntax-of-the-command",level:3}],u={toc:p},d="wrapper";function c(e){let{components:t,...r}=e;return(0,n.kt)(d,(0,o.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,"Use case: having 2 builds for different PRs, being able to trigger TF tests using both builds with a Packit\ncommand comment in one PR"),(0,n.kt)("h2",{id:"architecture-notes"},"Architecture notes"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"Copr allows interlinking Copr projects so that TF could just install proper packages and Copr would enable the whole dependency chain")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"it is possible to specify ",(0,n.kt)("inlineCode",{parentName:"li"},"runtime_dependencies")," in Copr: ",(0,n.kt)("a",{parentName:"li",href:"https://pagure.io/copr/copr/pull-request/2245#"},"https://pagure.io/copr/copr/pull-request/2245#"),"\n(should be released soon) - list of external repositories that will be automatically enabled together with this project repository"),(0,n.kt)("li",{parentName:"ul"},"we would need to have a dynamic way of specifying these ",(0,n.kt)("inlineCode",{parentName:"li"},"runtime_dependencies")),(0,n.kt)("li",{parentName:"ul"},"since we want concrete packages to be installed in TF (we pass the build ID and NVRs), this wouldn't be enough",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"if users build all the PRs in one Copr repo (e.g.\n",(0,n.kt)("a",{parentName:"li",href:"https://github.com/oamg/leapp/blob/351cfe75ce1a7e10d7e565d9fa0bdc946a9af66d/.packit.yaml#L9"},"leapp")," and\n",(0,n.kt)("a",{parentName:"li",href:"https://github.com/oamg/leapp-repository/blob/8b228941d34b3fcf4322353806fdcafa9fbba550/.packit.yaml#L26"},"leapp-repository")," build their PRs in one common Copr repo)\nwe cannot enforce with this solution what should be installed during tests (build ID, NVRs).")))),(0,n.kt)("h2",{id:"possible-implementation"},"Possible implementation"),(0,n.kt)("h3",{id:"requirements"},"Requirements"),(0,n.kt)("p",null,"The requirement would be to have enabled Packit Copr build job on both repositories where the PRs are happening.\nThen, the testing farm test job could be triggered by comment specifying the other pull request ID\nand we would rely on builds being already done by Packit."),(0,n.kt)("h3",{id:"implementation"},"Implementation"),(0,n.kt)("p",null,"We should have everything needed in our database and be able to get Copr build ID and package NVRs via having the other PR ID from there:\n",(0,n.kt)("inlineCode",{parentName:"p"},"PullRequestModel.get_or_create(pr_id=xy, namespace=xy, repo_name=xy, project_url=xy).get_copr_builds()"),"\nand determine the latest build comparing one of the stored times (task_accepted, build_submitted)."),(0,n.kt)("p",null,"With having the Copr build ID and package NVRs of the other PR Copr build, we could just pass these\ninto the Testing farm payload."),(0,n.kt)("p",null,"Process:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Try to get the PR specified in the comment from the DB - if not able to find, report this to user"),(0,n.kt)("li",{parentName:"ol"},"Get the latest Copr build for the PR from the DB - if no Copr build, report this to user"),(0,n.kt)("li",{parentName:"ol"},"Append artifact including the ID of the Copr build and NVRs to the payload for Testing Farm"),(0,n.kt)("li",{parentName:"ol"},"Trigger the tests"),(0,n.kt)("li",{parentName:"ol"},'When reporting the status, make sure it is done on the "main" PR (probably corresponding to the\nfirst one build in the artifacts)')),(0,n.kt)("h4",{id:"another-option"},"Another option"),(0,n.kt)("p",null,"There is also an option to get the needed info via Copr API, but in that case, we would need to know\nthe name of the Copr project where the build from another PR is. We could require the build to be in\nthe default-named Copr repo (this way we could easily construct the default name of the repo for other PR\nand work with that repo via API - get the latest build ID, NVRs). Allowing non-default Copr project would mean\nwe would need to obtain the package config from the repo where the other PR is created so that we\ncan work with the correct Copr project."),(0,n.kt)("h3",{id:"models"},"Models"),(0,n.kt)("p",null,"Currently, each pipeline model can be linked to one Copr build model (and also one SRPM model) and one TF model at most.\nOptions:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Do not store the information about the other PR build. Consequences => the other PR build would not\nbe displayed in the dashboard, we would lose this information."),(0,n.kt)("li",{parentName:"ol"},"Do not modify the PipelineModel, store this as 2 pipelines and store the relationship of the pipelines."),(0,n.kt)("li",{parentName:"ol"},"Modification of PipelineModel probably does not make sense since we have to store not only the copr build, but also\nthe connected SRPM build.")),(0,n.kt)("h3",{id:"retriggering"},"Retriggering"),(0,n.kt)("p",null,"How can a testing farm job be retriggered:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"via comment - we would require each time to explicitly pass the PR related attributes"),(0,n.kt)("li",{parentName:"ol"},"via Github check - we would trigger the tests only with the build from the current PR")),(0,n.kt)("h3",{id:"syntax-of-the-command"},"Syntax of the command"),(0,n.kt)("p",null,"Do we want to support specifying also Git forge?"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"from the implementation point, this should not be a problem (the data should be stored in the same way)"),(0,n.kt)("li",{parentName:"ul"},"we can behave similarly as for the default Copr project naming schema: implicitly Github PRs")),(0,n.kt)("p",null,"suggestions:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("inlineCode",{parentName:"p"},"/packit test --pr-id 123 --repository repo --namespace namespace (--forge github.com)"))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("inlineCode",{parentName:"p"},"/packit test namespace/repo#123")))),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"this looks like a preferred format")),(0,n.kt)("ol",{start:3},(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("inlineCode",{parentName:"p"},"/packit test github.com/namespace/repo#123"))),(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("p",{parentName:"li"},(0,n.kt)("inlineCode",{parentName:"p"},"/packit test github.com/namespace/repo#pr:123")))))}c.isMDXComponent=!0}}]);