"use strict";(self.webpackChunkpackit_dev=self.webpackChunkpackit_dev||[]).push([[4488],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var i=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=i.createContext({}),p=function(e){var t=i.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=p(e.components);return i.createElement(s.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},h=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(n),h=a,m=u["".concat(s,".").concat(h)]||u[h]||d[h]||r;return n?i.createElement(m,o(o({ref:t},c),{},{components:n})):i.createElement(m,o({ref:t},c))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,o=new Array(r);o[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[u]="string"==typeof e?e:a,o[1]=l;for(var p=2;p<r;p++)o[p]=n[p];return i.createElement.apply(null,o)}return i.createElement.apply(null,n)}h.displayName="MDXCreateElement"},4200:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var i=n(87462),a=(n(67294),n(3905));const r={title:"Deploy a testing instance",authors:"csomh"},o=void 0,l={unversionedId:"deployment/deploy-packit-pr",id:"deployment/deploy-packit-pr",title:"Deploy a testing instance",description:"Acceptance criteria",source:"@site/research/deployment/deploy-packit-pr.md",sourceDirName:"deployment",slug:"/deployment/deploy-packit-pr",permalink:"/research/deployment/deploy-packit-pr",draft:!1,editUrl:"https://github.com/packit/research/tree/main/research/deployment/deploy-packit-pr.md",tags:[],version:"current",frontMatter:{title:"Deploy a testing instance",authors:"csomh"},sidebar:"autogenerated",previous:{title:"Automotive clusters",permalink:"/research/deployment/automotive-rosa"},next:{title:"Packit Service deployment improvements",permalink:"/research/deployment/deployment-improvements/"}},s={},p=[{value:"Acceptance criteria",id:"acceptance-criteria",level:2},{value:"How should the deployment be triggered?",id:"how-should-the-deployment-be-triggered",level:2},{value:"What if multiple repositories are involved?",id:"what-if-multiple-repositories-are-involved",level:2},{value:"What are the steps required to deploy the new content?",id:"what-are-the-steps-required-to-deploy-the-new-content",level:2},{value:"Where to build the images?",id:"where-to-build-the-images",level:2},{value:"Which namespace/cluster should we use for the deployment?",id:"which-namespacecluster-should-we-use-for-the-deployment",level:2},{value:"Environment isolation tactics",id:"environment-isolation-tactics",level:2},{value:"What about partial deployments?",id:"what-about-partial-deployments",level:2},{value:"How to indicate that the environment is being used?",id:"how-to-indicate-that-the-environment-is-being-used",level:2}],c={toc:p},u="wrapper";function d(e){let{components:t,...r}=e;return(0,a.kt)(u,(0,i.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"acceptance-criteria"},"Acceptance criteria"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"figure out how we want to do this epic"),(0,a.kt)("li",{parentName:"ul"},"write down your findings in a document"),(0,a.kt)("li",{parentName:"ul"},"discuss with the team and get a consensus")),(0,a.kt)("h2",{id:"how-should-the-deployment-be-triggered"},"How should the deployment be triggered?"),(0,a.kt)("p",null,"At least in the beginning we might not want to deploy every single PR, so we\nmight need to have an explicit way for triggering this."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Minimal solution:")," write a script taking some arguments, which each of us\ncan run locally. For this each of us would need to have the credentials to the\nenvironment(s) the script needs to interact with."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"One step further:")," have some service/bot, listening to GitHub\ncomments/label changes and running the deployment script. We could check with\nsoftwarefactory folks if we could get a new Zuul pipeline to handle this. Or\nuse GitHub Actions... Secrets to access and manage the test environment will\nneed to be shared with this service."),(0,a.kt)("h2",{id:"what-if-multiple-repositories-are-involved"},"What if multiple repositories are involved?"),(0,a.kt)("p",null,"The script/bot should understand references to PRs of the repositories. (Later\non we can extend this to be able to reference branches or commits or even\ndifferent repositories, but for the beginning we can stick to PRs.)"),(0,a.kt)("p",null,"By default all components should use stg images, but it should be possible to\nmodify this default to 'prod'."),(0,a.kt)("p",null,"Repositories:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"packit/packit-service"),(0,a.kt)("li",{parentName:"ul"},"packit/packit"),(0,a.kt)("li",{parentName:"ul"},"packit/ogr"),(0,a.kt)("li",{parentName:"ul"},"packit/dashboard"),(0,a.kt)("li",{parentName:"ul"},"packit/tokman"),(0,a.kt)("li",{parentName:"ul"},"packit/sandcastle"),(0,a.kt)("li",{parentName:"ul"},"packit/deployment"),(0,a.kt)("li",{parentName:"ul"},"packit/packit-service-centosmsg"),(0,a.kt)("li",{parentName:"ul"},"packit/packit-service-fedmsg")),(0,a.kt)("p",null,"Examples:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ deploy --base=prod packit-service=614\n$ deploy packit-service=800 ogr=123\n$ deploy packit=456 deployment=321\n")),(0,a.kt)("h2",{id:"what-are-the-steps-required-to-deploy-the-new-content"},"What are the steps required to deploy the new content?"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Build images from the PRs."),(0,a.kt)("li",{parentName:"ol"},"Check if the test environment is free."),(0,a.kt)("li",{parentName:"ol"},"Make sure the test environment is cleaned up after previous deployments."),(0,a.kt)("li",{parentName:"ol"},"Run deployment with the new images.")),(0,a.kt)("h2",{id:"where-to-build-the-images"},"Where to build the images?"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Docker Hub",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Slow; there can be only one build in our project, since we are using a\nfree account."),(0,a.kt)("li",{parentName:"ul"},"It's not that obvious how to trigger on-demand builds from PRs.",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Actually, @sakalosj told that it's possible to trigger builds using the\nDocker Hub API, but the method is not documented."))))),(0,a.kt)("li",{parentName:"ul"},"Quay",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"http://docs.quay.io/guides/custom-trigger.html"},"Similar")," to Docker Hub."))),(0,a.kt)("li",{parentName:"ul"},"OpenShift Online",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Costs us money."),(0,a.kt)("li",{parentName:"ul"},"But we could use resource limits to have it under control."))),(0,a.kt)("li",{parentName:"ul"},"PSI",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Behind the firewall."),(0,a.kt)("li",{parentName:"ul"},"But builds could push images to a public registry.")))),(0,a.kt)("h2",{id:"which-namespacecluster-should-we-use-for-the-deployment"},"Which namespace/cluster should we use for the deployment?"),(0,a.kt)("p",null,"The original idea was to use stg, but maybe it would be better to have a dev\nenvironment, so that we can keep stg for pre-prod integration."),(0,a.kt)("p",null,"API endpoints of the test deployment should be publicly available, in order to\nallow the connected services to reach it. Because of this, these deployments\nwill need to be done in OpenShift Online (at least at the beginning)."),(0,a.kt)("h2",{id:"environment-isolation-tactics"},"Environment isolation tactics"),(0,a.kt)("p",null,"Packit-as-a-Service interacts with many other services, so we need to make\nsure that different deployments of Packit-as-a-Service don't conflict with\neach other, when it comes to interacting with these services."),(0,a.kt)("p",null,"Here are the ways we could achieve this:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Each deployment has it's own GitHub App."),(0,a.kt)("li",{parentName:"ul"},"Each deployment has it's own FAS user account.",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"And so it's own Copr account."),(0,a.kt)("li",{parentName:"ul"},"We'll need to manually create these FAS users."))),(0,a.kt)("li",{parentName:"ul"},"Each deployment is using it's own Copr organisation."),(0,a.kt)("li",{parentName:"ul"},"Each deployment is using it's own GitLab.com account."),(0,a.kt)("li",{parentName:"ul"},"Dist-git is more problematic, as we don't want to create noise in prod\ndist-git with all the testing activities, but there is currently no stg\ninstance we could use either.",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"To test interacting with dist-git PRs we can use repositories owned by us."))),(0,a.kt)("li",{parentName:"ul"},"The service only reacts to Copr events for builds which were started by it.")),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Environments",src:n(24959).Z,width:"981",height:"556"})),(0,a.kt)("h2",{id:"what-about-partial-deployments"},"What about partial deployments?"),(0,a.kt)("p",null,"In some cases it might make sense not to deploy the whole thing, but only a\npart of it. We could use the ",(0,a.kt)("inlineCode",{parentName:"p"},"with_*")," flags for this, but not sure if enabling\nthis is a priority."),(0,a.kt)("h2",{id:"how-to-indicate-that-the-environment-is-being-used"},"How to indicate that the environment is being used?"),(0,a.kt)("p",null,"As for the beginning we will have a single environment we'll need some way to\nindicate that it's \"taken\"."),(0,a.kt)("p",null,"We could have some OpenShift object set in the project when there is a\ndeployment running in it."),(0,a.kt)("p",null,"We could set a time-limit on test deployments, so that we don't accidentally\nleave the environment blocked."))}d.isMDXComponent=!0},24959:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/testing-prs-88d124758e42f6002b42b43c1c341d04.svg"}}]);