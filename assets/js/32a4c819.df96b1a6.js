"use strict";(self.webpackChunkpackit_dev=self.webpackChunkpackit_dev||[]).push([[6144],{3905:(e,t,r)=>{r.d(t,{Zo:()=>c,kt:()=>m});var a=r(67294);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function i(e,t){if(null==e)return{};var r,a,n=function(e,t){if(null==e)return{};var r,a,n={},o=Object.keys(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)r=o[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var p=a.createContext({}),l=function(e){var t=a.useContext(p),r=t;return e&&(r="function"==typeof e?e(t):s(s({},t),e)),r},c=function(e){var t=l(e.components);return a.createElement(p.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var r=e.components,n=e.mdxType,o=e.originalType,p=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),d=l(r),h=n,m=d["".concat(p,".").concat(h)]||d[h]||u[h]||o;return r?a.createElement(m,s(s({ref:t},c),{},{components:r})):a.createElement(m,s({ref:t},c))}));function m(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var o=r.length,s=new Array(o);s[0]=h;var i={};for(var p in t)hasOwnProperty.call(t,p)&&(i[p]=t[p]);i.originalType=e,i[d]="string"==typeof e?e:n,s[1]=i;for(var l=2;l<o;l++)s[l]=r[l];return a.createElement.apply(null,s)}return a.createElement.apply(null,r)}h.displayName="MDXCreateElement"},65485:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>p,contentTitle:()=>s,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var a=r(87462),n=(r(67294),r(3905));const o={title:"Distributed workers",authors:"jpopelka"},s=void 0,i={unversionedId:"deployment/distributed-workers/index",id:"deployment/distributed-workers/index",title:"Distributed workers",description:"Currently, we run packit service in Openshift Online, because we need our API (httpd/service)",source:"@site/research/deployment/distributed-workers/index.md",sourceDirName:"deployment/distributed-workers",slug:"/deployment/distributed-workers/",permalink:"/research/deployment/distributed-workers/",draft:!1,editUrl:"https://github.com/packit/research/tree/main/research/deployment/distributed-workers/index.md",tags:[],version:"current",frontMatter:{title:"Distributed workers",authors:"jpopelka"},sidebar:"autogenerated",previous:{title:"Packit Service deployment improvements",permalink:"/research/deployment/deployment-improvements/"},next:{title:"Cloud databases",permalink:"/research/deployment/distributed-workers/AWS-SQS-RDS"}},p={},l=[{value:"Public broker &amp; backend",id:"public-broker--backend",level:2},{value:"Route",id:"route",level:3},{value:"Exposing a service",id:"exposing-a-service",level:3},{value:"Load Balancer",id:"load-balancer",level:4},{value:"NodePort",id:"nodeport",level:4},{value:"ExternalIP",id:"externalip",level:4},{value:"oc port-forward",id:"oc-port-forward",level:4},{value:"Other Celery supported brokers",id:"other-celery-supported-brokers",level:2},{value:"RabbitMQ",id:"rabbitmq",level:3},{value:"AWS SQS",id:"aws-sqs",level:3},{value:"Other SQLAlchemy/Celery supported databases",id:"other-sqlalchemycelery-supported-databases",level:2}],c={toc:l},d="wrapper";function u(e){let{components:t,...r}=e;return(0,n.kt)(d,(0,a.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,"Currently, we run packit service in Openshift Online, because we need our API (httpd/service)\nand dashboard to be publicly accessible. The most resources however consume workers,\nwhich on the other hand don't need to be publicly available.\nSo the idea was to run (only) workers in an internal cluster which is not publicly accessible,\nbut we don't have to pay for it."),(0,n.kt)("h2",{id:"public-broker--backend"},"Public broker & backend"),(0,n.kt)("p",null,"Because service and workers communicate via Celery we need the broker (Redis)\nand backend (PostgreSQL) to be publicly accessible."),(0,n.kt)("h3",{id:"route"},"Route"),(0,n.kt)("p",null,"If Redis/PostgreSQL were using HTTP(S) protocol, their exposing would be\nas simple as creating a route for them.\nUnfortunately (see ",(0,n.kt)("a",{parentName:"p",href:"https://docs.openshift.com/container-platform/3.11/architecture/networking/routes.html#routers"},"here"),"\nand ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/openshift/origin/issues/3415#issuecomment-137902453"},"here"),"),\nroutes are only for HTTP(S) or TLS+",(0,n.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Server_Name_Indication"},"SNI"),"."),(0,n.kt)("p",null,"Both, ",(0,n.kt)("a",{parentName:"p",href:"https://redis.io/topics/encryption"},"Redis (starting with latest version 6)"),"\nand PostgreSQL can talk TLS, but they don't seem to have SNI support implemented, see\n",(0,n.kt)("a",{parentName:"p",href:"https://github.com/redis/redis/issues/7210#issuecomment-626381723"},"here"),",\n",(0,n.kt)("a",{parentName:"p",href:"https://www.postgresql.org/message-id/9af47a45-f92d-7ede-2d71-222ba24447eb%402ndquadrant.com"},"here"),"\nand ",(0,n.kt)("a",{parentName:"p",href:"https://www.postgresql.org/message-id/d05341b9-033f-d5fe-966e-889f5f9218e5%40proxel.se"},"here"),"."),(0,n.kt)("h3",{id:"exposing-a-service"},"Exposing a service"),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://docs.openshift.com/container-platform/3.11/dev_guide/expose_service/index.html"},"Other options (than route) for exposing a service are Load Balancer, NodePort and ExternalIP"),".\nUnfortunately, none of them I succeeded to use on Openshift Online."),(0,n.kt)("h4",{id:"load-balancer"},(0,n.kt)("a",{parentName:"h4",href:"https://docs.openshift.com/container-platform/3.11/dev_guide/expose_service/expose_internal_ip_load_balancer.html"},"Load Balancer")),(0,n.kt)("p",null,"Creating a Load Balancer is a privileged operation and we're not allowed to do that on OS Online."),(0,n.kt)("h4",{id:"nodeport"},(0,n.kt)("a",{parentName:"h4",href:"https://docs.openshift.com/container-platform/3.11/dev_guide/expose_service/expose_internal_ip_nodeport.html"},"NodePort")),(0,n.kt)("p",null,"Is a\n",(0,n.kt)("a",{parentName:"p",href:"https://docs.openshift.com/container-platform/3.11/architecture/core_concepts/pods_and_services.html#service-nodeport"},"privileged operation"),"\nand requires additional port resources."),(0,n.kt)("h4",{id:"externalip"},(0,n.kt)("a",{parentName:"h4",href:"https://docs.openshift.com/container-platform/3.11/dev_guide/expose_service/expose_internal_ip_service.html"},"ExternalIP")),(0,n.kt)("p",null,"Downside of using ExternalIP\nis that it ",(0,n.kt)("a",{parentName:"p",href:"https://access.redhat.com/solutions/3178591"},"consumes an IP address"),", so you already need to have one to assign to it."),(0,n.kt)("h4",{id:"oc-port-forward"},"oc port-forward"),(0,n.kt)("p",null,"Just for debugging/developing, needs to be done on client side."),(0,n.kt)("h2",{id:"other-celery-supported-brokers"},"Other Celery supported brokers"),(0,n.kt)("p",null,"Leaving aside that Redis can't do SNI, ",(0,n.kt)("a",{parentName:"p",href:"https://redis.io/topics/security"},"quoting"),':\n"Redis is designed to be accessed by trusted clients inside trusted environments.\nThis means that usually it is not a good idea to expose the Redis instance\ndirectly to the internet or, in general, to an environment where untrusted clients\ncan directly access the Redis TCP port or UNIX socket."'),(0,n.kt)("h3",{id:"rabbitmq"},(0,n.kt)("a",{parentName:"h3",href:"https://docs.celeryproject.org/en/stable/getting-started/brokers/rabbitmq.html"},"RabbitMQ")),(0,n.kt)("p",null,"Supports ",(0,n.kt)("a",{parentName:"p",href:"https://www.rabbitmq.com/ssl.html#erlang-ssl"},"SSL/TLS"),"\nand ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/rabbitmq/rabbitmq-server/issues/789"},"SNI as well"),"."),(0,n.kt)("h3",{id:"aws-sqs"},(0,n.kt)("a",{parentName:"h3",href:"https://docs.celeryproject.org/en/stable/getting-started/brokers/sqs.html"},"AWS SQS")),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://aws.amazon.com/sqs/pricing"},"Price is \\$0.5 per million messages"),".\nCurrently we're producing/consuming around 1200 messages per day\nso at this rate we'd be paying around 18 cents (\\$0.018) a month for using SQS."),(0,n.kt)("h2",{id:"other-sqlalchemycelery-supported-databases"},"Other SQLAlchemy/Celery supported databases"),(0,n.kt)("p",null,"We use PostgreSQL via SQLAlchemy either ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/packit-service/packit-service/blob/master/packit_service/models.py"},"directly"),"\nor as a ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/packit-service/packit-service/blob/master/packit_service/celerizer.py#L49"},"Celery result backend"),".\nIf we can't use it because it doesn't support SNI, then we have to find other free/open source,\n",(0,n.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/13/dialects/index.html"},"SQLAlchemy supported database"),"\nthat supports TLS+SNI:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"SQLite - ",(0,n.kt)("a",{parentName:"li",href:"https://github.com/packit-service/research/tree/master/data-stores#cons"},"nogo")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://hub.docker.com/_/mariadb"},"MariaDB")," - ",(0,n.kt)("a",{parentName:"li",href:"https://mariadb.com/kb/en/securing-connections-for-client-and-server"},"supports TLS")," but not ",(0,n.kt)("a",{parentName:"li",href:"https://jira.mariadb.org/browse/MDEV-10658"},"SNI")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://hub.docker.com/_/mysql"},"MySQL")," - ",(0,n.kt)("a",{parentName:"li",href:"https://dev.mysql.com/doc/refman/8.0/en/using-encrypted-connections.html"},"supports TLS")," but not ",(0,n.kt)("a",{parentName:"li",href:"https://bugs.mysql.com/bug.php?id=84849"},"SNI")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://hub.docker.com/r/jacobalberty/firebird/"},"Firebird")," - ",(0,n.kt)("a",{parentName:"li",href:"https://www.firebirdsql.org/file/documentation/release_notes/html/en/3_0/rnfb30-security-new-authentication.html#rnfb30-security-ssltls"},"supports TLS"),", no reference to SNI")),(0,n.kt)("p",null,"Or use cloud database, like ",(0,n.kt)("a",{parentName:"p",href:"https://aws.amazon.com/rds/postgresql"},"AWS RDS for PostgreSQL"),"\nwhose ",(0,n.kt)("a",{parentName:"p",href:"https://aws.amazon.com/rds/postgresql/pricing"},"pricing"),"\nstarts at $0.018/hour ($13/month) for ",(0,n.kt)("a",{parentName:"p",href:"https://aws.amazon.com/rds/instance-types"},"db.t3.micro")," (1GiB mem)."))}u.isMDXComponent=!0}}]);