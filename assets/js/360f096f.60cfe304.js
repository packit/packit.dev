"use strict";(self.webpackChunkpackit_dev=self.webpackChunkpackit_dev||[]).push([[76859],{15680:(e,t,n)=>{n.d(t,{xA:()=>p,yg:()=>u});var a=n(96540);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(n),h=r,u=d["".concat(l,".").concat(h)]||d[h]||m[h]||o;return n?a.createElement(u,i(i({ref:t},p),{},{components:n})):a.createElement(u,i({ref:t},p))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[d]="string"==typeof e?e:r,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},28369:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>m,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var a=n(58168),r=(n(96540),n(15680));const o={title:"\u2039commit_sha\u203a refactor follow-up",authors:"mmassari"},i="commit_sha refactor follow-up",s={unversionedId:"database/refactoring_project_events_and_commit_sha",id:"database/refactoring_project_events_and_commit_sha",title:"\u2039commit_sha\u203a refactor follow-up",description:"Database refactoring from PR https//github.com/packit/packit-service/issues/1328 has:",source:"@site/research/database/refactoring_project_events_and_commit_sha.md",sourceDirName:"database",slug:"/database/refactoring_project_events_and_commit_sha",permalink:"/research/database/refactoring_project_events_and_commit_sha",draft:!1,editUrl:"https://github.com/packit/research/tree/main/research/database/refactoring_project_events_and_commit_sha.md",tags:[],version:"current",frontMatter:{title:"\u2039commit_sha\u203a refactor follow-up",authors:"mmassari"},sidebar:"autogenerated",previous:{title:"Postgres views",permalink:"/research/database/postgres-views/"},next:{title:"Database refresh",permalink:"/research/database/refresh"}},l={},c=[{value:"These are some of the thoughts that came to my mind after having worked on this:",id:"these-are-some-of-the-thoughts-that-came-to-my-mind-after-having-worked-on-this",level:4}],p={toc:c},d="wrapper";function m(e){let{components:t,...n}=e;return(0,r.yg)(d,(0,a.A)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.yg)("h1",{id:"commit_sha-refactor-follow-up"},(0,r.yg)("inlineCode",{parentName:"h1"},"commit_sha")," refactor follow-up"),(0,r.yg)("p",null,"Database refactoring from PR ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/packit/packit-service/pull/2070"},"https://github.com/packit/packit-service/pull/2070")," related with issue ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/packit/packit-service/issues/1328"},"https://github.com/packit/packit-service/issues/1328")," has:"),(0,r.yg)("ul",null,(0,r.yg)("li",{parentName:"ul"},"renamed ",(0,r.yg)("inlineCode",{parentName:"li"},"JobTriggerModel")," in ",(0,r.yg)("inlineCode",{parentName:"li"},"ProjectEventModel")),(0,r.yg)("li",{parentName:"ul"},"removed the ",(0,r.yg)("inlineCode",{parentName:"li"},"commit_sha")," field from ",(0,r.yg)("inlineCode",{parentName:"li"},"CoprBuildTargetModel"),", ",(0,r.yg)("inlineCode",{parentName:"li"},"KojiBuildTargetModel"),", ",(0,r.yg)("inlineCode",{parentName:"li"},"SRPMBuildModel"),", ",(0,r.yg)("inlineCode",{parentName:"li"},"TFTTestRunGroupModel"),", ",(0,r.yg)("inlineCode",{parentName:"li"},"VMImageBuildTargetModel")," and moved it into the ",(0,r.yg)("inlineCode",{parentName:"li"},"ProjectEventModel"))),(0,r.yg)("h4",{id:"these-are-some-of-the-thoughts-that-came-to-my-mind-after-having-worked-on-this"},"These are some of the thoughts that came to my mind after having worked on this:"),(0,r.yg)("p",null,"I always thought that a ",(0,r.yg)("inlineCode",{parentName:"p"},"JobTriggerModel"),' was an "event" able to trigger jobs in packit-service.\nBut we were not using the ',(0,r.yg)("inlineCode",{parentName:"p"},"JobTriggerModel")," like an event: two different pushes to the same pull request are two different pull request events but we were not saving two different rows in the ",(0,r.yg)("inlineCode",{parentName:"p"},"JobTriggerModel"),'. For this reason I would say that we were not dealing with events but just with "project objects" like pull requests, releases or issues.\nI can say that the ',(0,r.yg)("inlineCode",{parentName:"p"},"JobTriggerModel"),' was the base table of polymorphic entities: the "project objects" entities (pull request, branch push, release, issue).'),(0,r.yg)("p",null,"I have added the ",(0,r.yg)("inlineCode",{parentName:"p"},"commit_sha")," to the ",(0,r.yg)("inlineCode",{parentName:"p"},"ProjectEventModel")," (ex ",(0,r.yg)("inlineCode",{parentName:"p"},"JobTriggerModel"),") and ",(0,r.yg)("strong",{parentName:"p"},"now this is really an event table and I lose the base table for the polymorphic project object entities"),"!"),(0,r.yg)("p",null,"I see the relation between the ex ",(0,r.yg)("inlineCode",{parentName:"p"},"JobTriggerModel")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"PullRequestModel/GitBranchModel/[...]")," as the relation between ",(0,r.yg)("inlineCode",{parentName:"p"},"Employee")," and ",(0,r.yg)("inlineCode",{parentName:"p"},"Engineer/Manager"),"; I can not add a row in employee without adding a row in engineer or manager. Now I am adding many new rows in the ",(0,r.yg)("inlineCode",{parentName:"p"},"ProjectEventModel"),', one row for every new push with a new commit_sha, but I am not adding new rows to the project objects tables. Now this table is really a "project event" table and no more the base table for the "project objects".'),(0,r.yg)("p",null,"I think this refactoring could be further improved for the following reasons:"),(0,r.yg)("ol",null,(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"The ",(0,r.yg)("inlineCode",{parentName:"p"},"ProjectEventModel")," table now keeps track of events but just for those events that have a ",(0,r.yg)("inlineCode",{parentName:"p"},"commit_sha"),". For the issue's events, as an example, since there is no way to differentiate them we will end up having always just one event for the same issue (even though many comments have been created). ",(0,r.yg)("em",{parentName:"p"},"To have issue events in the table we need to save some other kind of information like the comment id.")),(0,r.yg)("p",{parentName:"li"},"Same thing for the release events generated with a ",(0,r.yg)("inlineCode",{parentName:"p"},"NewHotnessEvent"),", where I can't get the ",(0,r.yg)("inlineCode",{parentName:"p"},"commit_sha")," from the project, unless I refactorize completely this ",(0,r.yg)("a",{parentName:"p",href:"https://github.com/packit/packit-service/blob/34aa347efe8f06810134590244d514a67392ea5b/packit_service/worker/events/event.py#L148"},"method")," (here we need to use the specialized event classes and not the generic one)."),(0,r.yg)("p",{parentName:"li"},"A way to use the project event could be to collect in one view all related jobs triggered by the same event or a history of the events per project with their related jobs but we can not really do this, right now, since the above problems.")),(0,r.yg)("li",{parentName:"ol"},(0,r.yg)("p",{parentName:"li"},"We can not properly model an ",(0,r.yg)("inlineCode",{parentName:"p"},"hardly")," use case: for a ",(0,r.yg)("inlineCode",{parentName:"p"},"MergeRequestGitlabEvent")," we are dealing in hardly with a source_git ",(0,r.yg)("inlineCode",{parentName:"p"},"PullRequestModel")," object and a dist_git ",(0,r.yg)("inlineCode",{parentName:"p"},"PullRequestModel")," db object. They have different ",(0,r.yg)("inlineCode",{parentName:"p"},"commit_sha")," (because they are placed in two different git projects) but the event which triggered this job is just one. So it seems to me that we need a ",(0,r.yg)("inlineCode",{parentName:"p"},"n-m")," relationship between events and related project objects."),(0,r.yg)("p",{parentName:"li"},"The event by itself should not be forcibly related with a project object but, as a result, it will make packit-service work on one or more project objects."))),(0,r.yg)("p",null,"Probably a db re-design improvement could be something similar to the following:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre"},"events (EventModel)\n    id (PK)\n    type (event type?)\n\nproject_objects (ProjectObjectModel)\n    id (PK)\n    type (pull_request, branch_push, release, issue)\n\ncommit_sha (CommitSHAModel)\n    id (PK)\n    event_id (FK to EventModel)\n    project_object_id (FK to ProjectObjectModel)\n    commit_sha\n\ncomment (CommentModel)\n    id (PK)\n    event_id (FK to EventModel)\n    project_object_id (FK to ProjectObjectModel)\n    comment_id\n\npull_requests (PullRequestModel)\n    id (PK) (FK to ProjectObjectModel)\n    project_id (FK to GitProjectModel)\n    pr_id\n\ngit_branches (GitBranchModel)\n    id (PK) (FK to ProjectObjectModel)\n    project_id (FK to GitProjectModel)\n    issue_id\n\nissues (IssueModel)\n    id (PK) (FK to ProjectObjectModel)\n    project_id (FK to GitProjectModel)\n    name\n")))}m.isMDXComponent=!0}}]);