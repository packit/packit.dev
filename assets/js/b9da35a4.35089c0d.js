"use strict";(self.webpackChunkpackit_dev=self.webpackChunkpackit_dev||[]).push([[85230],{15680:(e,t,n)=>{n.d(t,{xA:()=>m,yg:()=>d});var a=n(96540);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var o=a.createContext({}),p=function(e){var t=a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},m=function(e){var t=p(e.components);return a.createElement(o.Provider,{value:t},e.children)},g="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,o=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),g=p(n),c=i,d=g["".concat(o,".").concat(c)]||g[c]||u[c]||r;return n?a.createElement(d,s(s({ref:t},m),{},{components:n})):a.createElement(d,s({ref:t},m))}));function d(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,s=new Array(r);s[0]=c;var l={};for(var o in t)hasOwnProperty.call(t,o)&&(l[o]=t[o]);l.originalType=e,l[g]="string"==typeof e?e:i,s[1]=l;for(var p=2;p<r;p++)s[p]=n[p];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},41621:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>s,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var a=n(58168),i=(n(96540),n(15680));const r={title:"Testing Farm",sidebar_position:2},s="Testing Farm",l={unversionedId:"configuration/upstream/tests",id:"configuration/upstream/tests",title:"Testing Farm",description:"Testing Farm is Packit's testing system.",source:"@site/docs/configuration/upstream/tests.md",sourceDirName:"configuration/upstream",slug:"/configuration/upstream/tests",permalink:"/docs/configuration/upstream/tests",draft:!1,editUrl:"https://github.com/packit/packit.dev/tree/main/docs/configuration/upstream/tests.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{title:"Testing Farm",sidebar_position:2},sidebar:"autogenerated",previous:{title:"Copr builds",permalink:"/docs/configuration/upstream/copr_build"},next:{title:"Koji builds",permalink:"/docs/configuration/upstream/upstream_koji_build"}},o={},p=[{value:"Supported triggers",id:"supported-triggers",level:2},{value:"Enable Testing",id:"enable-testing",level:2},{value:"Required parameters",id:"required-parameters",level:2},{value:"Optional parameters",id:"optional-parameters",level:2},{value:"Environment variables",id:"environment-variables",level:2},{value:"Retriggering",id:"retriggering",level:2},{value:"Test job statuses",id:"test-job-statuses",level:2},{value:"Creating Tests",id:"creating-tests",level:2},{value:"Example test structure",id:"example-test-structure",level:3},{value:"More Examples",id:"more-examples",level:2},{value:"Using Filters",id:"using-filters",level:3},{value:"Prepare Step",id:"prepare-step",level:3},{value:"Skip installation of artifacts",id:"skip-installation-of-artifacts",level:3},{value:"Apache Test",id:"apache-test",level:3},{value:"Systemd Tests",id:"systemd-tests",level:3},{value:"FMF Tests",id:"fmf-tests",level:3},{value:"Running linters",id:"running-linters",level:3},{value:"rpmlint",id:"rpmlint",level:4},{value:"rpminspect",id:"rpminspect",level:4},{value:"csmock",id:"csmock",level:3},{value:"Testing Farm API",id:"testing-farm-api",level:2},{value:"Public IDs of Packit tokens (for using secrets)",id:"public-ids-of-packit-tokens-for-using-secrets",level:3},{value:"Issues &amp; RFEs",id:"issues--rfes",level:2}],m={toc:p},g="wrapper";function u(e){let{components:t,...n}=e;return(0,i.yg)(g,(0,a.A)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,i.yg)("h1",{id:"testing-farm"},"Testing Farm"),(0,i.yg)("p",null,(0,i.yg)("a",{parentName:"p",href:"https://docs.testing-farm.io"},"Testing Farm")," is Packit's testing system.\nTest execution is managed by ",(0,i.yg)("a",{parentName:"p",href:"https://tmt.readthedocs.io/"},"tmt")," tool."),(0,i.yg)("h2",{id:"supported-triggers"},"Supported triggers"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"pull_request")," - check out content of the pull request"),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"commit")," - reacts to new commits to the specified branch"),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"release")," - check out content of the tag associated with the release")),(0,i.yg)("h2",{id:"enable-testing"},"Enable Testing"),(0,i.yg)("p",null,"In order to enable test execution simply include ",(0,i.yg)("inlineCode",{parentName:"p"},"tests")," and required ",(0,i.yg)("inlineCode",{parentName:"p"},"copr_build")," jobs in the ",(0,i.yg)("inlineCode",{parentName:"p"},".packit.yaml")," configuration:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},"jobs:\n- job: copr_build\n  trigger: pull_request\n  targets:\n  - fedora-all\n\n- job: tests\n  trigger: pull_request\n  targets:\n  - fedora-all\n")),(0,i.yg)("p",null,"The test job by default requires Copr build to be built before running tests, and then\nit is installed into the testing environment."),(0,i.yg)("admonition",{type:"note"},(0,i.yg)("p",{parentName:"admonition"},"If no test (",(0,i.yg)("inlineCode",{parentName:"p"},"fmf"),") metadata is defined in your repository or configuration (see below),\nthe default ",(0,i.yg)("a",{parentName:"p",href:"https://gitlab.com/testing-farm/tests/-/blob/main/packit/installation.fmf"},"installability test")," will be executed.\nThis test verifies that all built packages can be installed successfully.")),(0,i.yg)("p",null,"If you want to run tests without a Copr build, the test job needs to include ",(0,i.yg)("inlineCode",{parentName:"p"},"skip_build")," (described below) option in the job configuration:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},"  jobs:\n  - job: tests\n    trigger: pull_request\n    targets:\n    - fedora-all\n    skip_build: true\n")),(0,i.yg)("p",null,"If you want to run multiple ",(0,i.yg)("inlineCode",{parentName:"p"},"tests")," jobs for the same trigger with different configurations, you need to specify\nthe ",(0,i.yg)("inlineCode",{parentName:"p"},"identifier")," options (see ",(0,i.yg)("inlineCode",{parentName:"p"},"Optional parameters")," below):"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},"jobs:\n- job: copr_build\n  trigger: pull_request\n  targets:\n  - fedora-all\n  \n- job: tests\n  trigger: pull_request\n  identifier: first\n  targets:\n  - fedora-rawhide\n  \n- job: tests\n  trigger: pull_request\n  identifier: second\n  targets:\n  - fedora-latest-stable\n")),(0,i.yg)("p",null,"If you want to trigger tests via pull request comment and not by every new commit into the pull request, the test job needs to include ",(0,i.yg)("inlineCode",{parentName:"p"},"manual_trigger")," (described below) option in the job configuration:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},"  jobs:\n  - job: tests\n    trigger: pull_request\n    targets:\n    - fedora-all\n    skip_build: true\n    manual_trigger: true\n")),(0,i.yg)("admonition",{type:"info"},(0,i.yg)("p",{parentName:"admonition"},"If you have both build and follow-up test jobs with ",(0,i.yg)("inlineCode",{parentName:"p"},"manual_trigger: true"),", you will need to post\n2 comments: first ",(0,i.yg)("inlineCode",{parentName:"p"},"/packit build")," comment command and after the builds are successful ",(0,i.yg)("inlineCode",{parentName:"p"},"/packit test")," comment command.")),(0,i.yg)("p",null,"Another useful config is ",(0,i.yg)("inlineCode",{parentName:"p"},"labels")," option:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},"  jobs:\n  - job: tests\n    trigger: pull_request\n    targets:\n    - fedora-all\n    skip_build: true\n    manual_trigger: true\n    identifier: regression-upgrade\n    labels:\n      - upgrade\n      - regression\n      \n  - job: tests\n    trigger: pull_request\n    targets:\n    - fedora-all\n    skip_build: true\n    manual_trigger: true\n    identifier: upgrade\n    labels:\n      - regression\n")),(0,i.yg)("p",null,"For more info see ",(0,i.yg)("a",{parentName:"p",href:"/docs/configuration/upstream/tests#running-group-of-tests-with-same-label"},"Running group of tests with same label")),(0,i.yg)("h2",{id:"required-parameters"},"Required parameters"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"targets"),' - Specify which "builds" you want to test.\n',(0,i.yg)("a",{parentName:"li",href:"/docs/configuration/upstream/copr_build#available-copr-build-targets"},"As with copr_build job")," you can use\nspecific targets such as ",(0,i.yg)("inlineCode",{parentName:"li"},"fedora-34-x86_64"),". Or just the distro part,\nlike ",(0,i.yg)("inlineCode",{parentName:"li"},"centos-stream-8"),", in which case the architecture is ",(0,i.yg)("inlineCode",{parentName:"li"},"x86_64"),".")),(0,i.yg)("p",null,"You can also use the ",(0,i.yg)("a",{parentName:"p",href:"/docs/configuration#aliases"},"aliases provided by Packit"),"\nto not need to change the config file when the new system version is released."),(0,i.yg)("p",null,"Each target is then mapped to a ",(0,i.yg)("a",{parentName:"p",href:"https://tmt.readthedocs.io/en/latest/spec/context.html#dimension"},"(tmt) distro"),"\nand to a ",(0,i.yg)("a",{parentName:"p",href:"https://api.dev.testing-farm.io/v0.1/composes"},"Testing farm's compose"),"\nwhen submitting a test. You can override the default (target to distro) mapping by\nspecifying ",(0,i.yg)("inlineCode",{parentName:"p"},"targets")," as a dictionary instead of as a list (make sure to include the architecture\nof the target, e.g. not ",(0,i.yg)("inlineCode",{parentName:"p"},"epel-8")," but ",(0,i.yg)("inlineCode",{parentName:"p"},"epel-8-x86_64"),")."),(0,i.yg)("p",null,"In the following example, the ",(0,i.yg)("inlineCode",{parentName:"p"},"epel-8-x86_64")," build will be tested on ",(0,i.yg)("inlineCode",{parentName:"p"},"centos-8"),"\ndistro (otherwise the default would be ",(0,i.yg)("inlineCode",{parentName:"p"},"centos-stream-8"),") and for\n",(0,i.yg)("inlineCode",{parentName:"p"},"epel-7-x86_64")," build the default mapping (to ",(0,i.yg)("inlineCode",{parentName:"p"},"centos-7")," distro) will be used:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},"  targets:\n    epel-8-x86_64:\n      distros: [centos-8]\n    epel-7-x86_64: {}\n")),(0,i.yg)("h2",{id:"optional-parameters"},"Optional parameters"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"fmf_url")," - Git repository containing the metadata (",(0,i.yg)("inlineCode",{parentName:"li"},"fmf"),") tree.\nUse any format acceptable by the git clone command."),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"fmf_ref"),' - Branch, tag or commit specifying the desired git revision.\nDefaults to "master" when ',(0,i.yg)("strong",{parentName:"li"},"fmf_url")," is specified and ",(0,i.yg)("strong",{parentName:"li"},"fmf_ref")," is not."),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"fmf_path")," - Path to the fmf root (the parent path where ",(0,i.yg)("inlineCode",{parentName:"li"},".fmf")," folder is located) relative to the git root.\nDefaults to ",(0,i.yg)("inlineCode",{parentName:"li"},".")," (git root)."),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"tmt_plan")," - Run plans by the given name. Can be passed as a regular\nexpression."),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"tf_post_install_script")," - Bash script as a string to run during the guest provisioning. "),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"tf_extra_params")," - A free-form dictionary that allows specifying extra parameters to the Testing Farm.\nFor a complete list of parameters, refer to the ",(0,i.yg)("a",{parentName:"li",href:"https://api.testing-farm.io/redoc#operation/request_a_new_test_v0_1_requests_post"},"Testing Farm documentation"),".\nThe dictionary must follow the structure of the Testing Farm request. Options specified in the dictionary have the\nhighest precedence, i.e. can override Packit's defaults. They are being merged with the Packit's values, the only exception\nis the ",(0,i.yg)("inlineCode",{parentName:"li"},"artifacts")," list, which is combined with the artifact passed by Packit. Also, beware of indentation-sensitivity of the YAML format.\nYou can verify that the option is processed correctly using a ",(0,i.yg)("a",{parentName:"li",href:"https://yaml-online-parser.appspot.com/"},"YAML parser"),". Refer to the ",(0,i.yg)("a",{parentName:"li",href:"/docs/configuration/examples/#tests"},"configuration examples")," for more information."),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"skip_build")," - Whether to skip the build phase and only run tests (defaults to false).\nEnabling this will cause no Copr build to be built and installed into the testing environment,\nonly submitting request to Testing Farm (the selected components to be installed should be part of the TMT definitions)."),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"env")," - A dictionary you can use to set any environment variable that will be available in the Testing Farm\nenvironment where the tests are run."),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"identifier")," \u2013 Suffix added to the name of a GitHub check run. This is needed\nwhen you have multiple ",(0,i.yg)("inlineCode",{parentName:"li"},"tests")," jobs with different configuration. For\nexample if you set this to ",(0,i.yg)("inlineCode",{parentName:"li"},"e2e-tests"),", then a check run for Rawhide would be\nnamed ",(0,i.yg)("inlineCode",{parentName:"li"},"testing-farm:fedora-rawhide-x86_64:e2e-tests"),".",(0,i.yg)("admonition",{parentName:"li",type:"caution"},(0,i.yg)("p",{parentName:"admonition"},"The identifier ",(0,i.yg)("strong",{parentName:"p"},"must NOT contain colons (",(0,i.yg)("inlineCode",{parentName:"strong"},":"),")"),". Colons are used as delimiters in check names\nand will cause check rerun failures. Use alphanumeric characters, hyphens (",(0,i.yg)("inlineCode",{parentName:"p"},"-"),"), and\nunderscores (",(0,i.yg)("inlineCode",{parentName:"p"},"_"),") for best compatibility. For example, use ",(0,i.yg)("inlineCode",{parentName:"p"},"provision-virtual")," instead of ",(0,i.yg)("inlineCode",{parentName:"p"},"provision:virtual"),"."))),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"manual_trigger")," - Whether to trigger Testing Farm jobs only manually (via pull request comment ",(0,i.yg)("inlineCode",{parentName:"li"},"/packit test"),"  (",(0,i.yg)("inlineCode",{parentName:"li"},"/packit-stg test")," for staging instance) or rerunning the check in the GitHub UI) or not (defaults to false). "),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"labels")," - List of labels that group several jobs together. Users then use them when manually triggering the jobs like ",(0,i.yg)("inlineCode",{parentName:"li"},"/packit test --labels regression,upgrade"),"."),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"use_internal_tf")," - Whether to use the internal Testing Farm infrastructure (defaults to false).\nThis requires additional approval from our side (please, ",(0,i.yg)("a",{parentName:"li",href:"#contact"},"contact us")," in case you want to use it). "),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("strong",{parentName:"li"},"use_target_repo_for_fmf_url")," - Whether to use the target (upstream) repository for the ",(0,i.yg)("inlineCode",{parentName:"li"},"test.fmf.url"),"\nfield in a Testing Farm request, instead of the forked repository for pull requests from forks (defaults to false).\nThis also impacts ",(0,i.yg)("a",{parentName:"li",href:"#public-ids-of-packit-tokens-for-using-secrets"},"secrets handling"),".")),(0,i.yg)("h2",{id:"environment-variables"},"Environment variables"),(0,i.yg)("p",null,"There are also environment variables set by Packit:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_FULL_REPO_NAME")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_UPSTREAM_NAME")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_UPSTREAM_URL")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_DOWNSTREAM_NAME")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_DOWNSTREAM_URL")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_PACKAGE_NAME")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_PACKAGE_NVR")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_BUILD_LOG_URL")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_SRPM_URL")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_COMMIT_SHA")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_TAG_NAME"),", tag name from release event, not set if the test job doesn't have ",(0,i.yg)("strong",{parentName:"li"},"release")," trigger"),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_COPR_PROJECT"),", e.g. ",(0,i.yg)("inlineCode",{parentName:"li"},"packit/packit-releases")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_COPR_BUILD_ID")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_COPR_RPMS"),", space-separated list of RPMs that were built in Copr")),(0,i.yg)("p",null,"And there are also pairs of variables for pull-request jobs:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_SOURCE_SHA")," and ",(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_TARGET_SHA")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_SOURCE_BRANCH")," and ",(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_TARGET_BRANCH")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_SOURCE_URL")," and ",(0,i.yg)("inlineCode",{parentName:"li"},"PACKIT_TARGET_URL"))),(0,i.yg)("p",null,"Note that some variables do not need to be set if the value is unknown, irrelevant or not-configured."),(0,i.yg)("h2",{id:"retriggering"},"Retriggering"),(0,i.yg)("p",null,"For retriggering the job, see ",(0,i.yg)("a",{parentName:"p",href:"/docs/retriggering#tests"},"retriggering docs"),"."),(0,i.yg)("h2",{id:"test-job-statuses"},"Test job statuses"),(0,i.yg)("p",null,"By default, while test jobs are waiting for their corresponding build jobs to finish,\ntheir statuses share updates with the build jobs, for example ",(0,i.yg)("inlineCode",{parentName:"p"},"SRPM build is in progress..."),"\nor ",(0,i.yg)("inlineCode",{parentName:"p"},"Starting RPM build..."),". This can be disabled by setting\n",(0,i.yg)("a",{parentName:"p",href:"/docs/configuration#sync_test_job_statuses_with_builds"},(0,i.yg)("inlineCode",{parentName:"a"},"sync_test_job_statuses_with_builds")),"\nto ",(0,i.yg)("inlineCode",{parentName:"p"},"false"),". If disabled, test job statuses remain in pending state until their corresponding\nbuild jobs are finished."),(0,i.yg)("h2",{id:"creating-tests"},"Creating Tests"),(0,i.yg)("p",null,"The easiest way to get started with defining tests is to use the ",(0,i.yg)("a",{parentName:"p",href:"https://tmt.readthedocs.io/"},"tmt")," tool\nwhich will help you with the setup.\nPlease follow ",(0,i.yg)("a",{parentName:"p",href:"https://tmt.readthedocs.io/en/latest/guide.html"},"tmt's guide")," to get started."),(0,i.yg)("h3",{id:"example-test-structure"},"Example test structure"),(0,i.yg)("p",null,"Once your project is initialized, this is how your structure can look like:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre"},"$ tmt\nFound 3 tests: /tests/full, /tests/smoke and /tests_recording.\nFound 4 plans: /plans/full, /plans/rpmlint, /plans/session-recording and /plans/smoke.\nFound 0 stories.\n\n$ ls -1 plans/\nfull.fmf\nmain.fmf\nrpmlint.fmf\nsession-recording.fmf\nsmoke.fmf\n")),(0,i.yg)("h2",{id:"more-examples"},"More Examples"),(0,i.yg)("p",null,"Get inspiration for a quick start from a couple of real-life examples! These\nsamples live in ",(0,i.yg)("inlineCode",{parentName:"p"},".fmf")," files inside tests or plans directories. You can also have a look\nat ",(0,i.yg)("a",{parentName:"p",href:"https://tmt.readthedocs.io/en/stable/examples.html"},"tmt examples site"),"."),(0,i.yg)("h3",{id:"using-filters"},"Using Filters"),(0,i.yg)("p",null,"Use a custom ",(0,i.yg)("inlineCode",{parentName:"p"},"filter")," in the discover step in order to choose relevant tests only:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},'discover:\n    how: fmf\n    filter: "tier: 1"\n    url: https://src.fedoraproject.org/tests/selinux\n')),(0,i.yg)("h3",{id:"prepare-step"},"Prepare Step"),(0,i.yg)("p",null,"The ",(0,i.yg)("inlineCode",{parentName:"p"},"prepare")," step can be used to define how test environment should be prepared before testing.\nProvide one or more paths to ansible playbooks:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},"prepare:\n    how: ansible\n    playbook:\n        - setup/packages.yml\n")),(0,i.yg)("h3",{id:"skip-installation-of-artifacts"},"Skip installation of artifacts"),(0,i.yg)("p",null,"In certain scenarios, you may want to skip the installation of artifacts.\nTo do this, include the following in your ",(0,i.yg)("inlineCode",{parentName:"p"},"prepare")," step:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},'prepare:\n  - how: install\n    exclude:\n      - ".*"\n')),(0,i.yg)("h3",{id:"apache-test"},"Apache Test"),(0,i.yg)("p",null,"Here is an example of a simple integration test for the web server ",(0,i.yg)("inlineCode",{parentName:"p"},"httpd")," and ",(0,i.yg)("inlineCode",{parentName:"p"},"curl")," utility:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},"execute:\n    script:\n      - dnf -y install httpd curl\n      - systemctl start httpd\n      - echo foo > /var/www/html/index.html\n      - curl http://localhost/ | grep foo\n")),(0,i.yg)("p",null,"The plan above defines only the ",(0,i.yg)("inlineCode",{parentName:"p"},"execute")," step.\nIndividual shell commands are provided as a list.\nTesting will fail if any of the commands returns a non-zero exit status."),(0,i.yg)("h3",{id:"systemd-tests"},"Systemd Tests"),(0,i.yg)("p",null,"Below you can find a bit more interesting example of a ",(0,i.yg)("inlineCode",{parentName:"p"},"systemd")," test configuration:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},'summary:\n    Basic set of quick smoke tests for systemd.\ndiscover:\n    how: fmf\n    filter: "tier: 1 & distro: rhel-8"\n    url: "https://github.com/systemd-rhel/tests"\nprepare:\n    how: ansible\n    playbook: [setup/packages.yml]\nexecute:\n    how: tmt\n')),(0,i.yg)("p",null,"This plan enables a set of Tier 1 tests from the shared ",(0,i.yg)("a",{parentName:"p",href:"https://github.com/systemd-rhel/tests"},"systemd tests")," repository.\nThe meaning of individual attributes is as follows:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"summary \u2014 an optional but useful attribute describing high-level purpose of the plan."),(0,i.yg)("li",{parentName:"ul"},"discover \u2014 instructs to fetch tests from given repository and select relevant ones by provided ",(0,i.yg)("inlineCode",{parentName:"li"},"filter"),"."),(0,i.yg)("li",{parentName:"ul"},"prepare \u2014 specifies which ansible playbook should be applied to prepare environment for testing."),(0,i.yg)("li",{parentName:"ul"},"execute \u2014 defines that the ",(0,i.yg)("inlineCode",{parentName:"li"},"tmt")," should be used for running the tests.")),(0,i.yg)("h3",{id:"fmf-tests"},"FMF Tests"),(0,i.yg)("p",null,"Here's a real-life example of tests enabled for the ",(0,i.yg)("a",{parentName:"p",href:"https://fmf.readthedocs.io/"},"fmf")," package.\nThere are several plans defined under the ",(0,i.yg)("a",{parentName:"p",href:"https://github.com/psss/fmf/tree/master/plans"},"plans")," directory.\nThe ",(0,i.yg)("inlineCode",{parentName:"p"},"smoke")," plan enables a super basic test checking availability of the ",(0,i.yg)("inlineCode",{parentName:"p"},"fmf")," command:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},"summary:\n    Just a basic smoke test\nexecute:\n    script: fmf --help\n")),(0,i.yg)("p",null,"Plan ",(0,i.yg)("inlineCode",{parentName:"p"},"features")," is used to execute all available beakerlib tests from the ",(0,i.yg)("inlineCode",{parentName:"p"},"fmf")," repository:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},"summary:\n    Essential command line features\ndiscover:\n    how: fmf\n    url: https://github.com/psss/fmf\nexecute:\n    how: tmt\n")),(0,i.yg)("p",null,"It is also possible to select only a subset of available tests.\nThis is demonstrated by the ",(0,i.yg)("inlineCode",{parentName:"p"},"docs")," plan.\nUse an fmf ",(0,i.yg)("inlineCode",{parentName:"p"},"filter")," like ",(0,i.yg)("inlineCode",{parentName:"p"},"tier:1")," to select tests for execution.\nYou can also reference a specific feature area instead:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},"summary:\n    Ensure that documentation is present\ndiscover:\n    how: fmf\n    url: https://github.com/psss/fmf\n    filter: coverage:/stories/docs.*\nexecute:\n    how: tmt\n")),(0,i.yg)("p",null,"See the ",(0,i.yg)("a",{parentName:"p",href:"https://github.com/psss/fmf/tree/master/stories"},"stories")," directory to get some inspiration for organizing stories and requirements."),(0,i.yg)("h3",{id:"running-linters"},"Running linters"),(0,i.yg)("p",null,"Running linters on your code is easy to set up using Testing Farm and tmt.\nLinters are tools which you can install from the distribution, and they usually\njust require a path to files which they check. Here is a plan which you can use\nto run ",(0,i.yg)("inlineCode",{parentName:"p"},"rpmlint")," on your spec file."),(0,i.yg)("h4",{id:"rpmlint"},"rpmlint"),(0,i.yg)("p",null,"We are checking our spec files with rpmlint in our project:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://github.com/packit/ogr/blob/main/plans/linters.fmf"},"ogr - plans/linters.fmf")),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"https://github.com/packit/packit/blob/main/plans/rpmlint.fmf"},"Packit - plans/rpmlint.fmf"))),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},"summary:\n    Execute rpmlint on the spec file\ndiscover:\n    how: shell\n    tests:\n      - name: rpmlint\n        test: rpmlint packit.spec\nprepare:\n  - name: packages\n    how: install\n    package:\n    - rpmlint\nexecute:\n    how: tmt\n")),(0,i.yg)("h4",{id:"rpminspect"},"rpminspect"),(0,i.yg)("p",null,(0,i.yg)("a",{parentName:"p",href:"https://github.com/rpminspect/rpminspect"},(0,i.yg)("inlineCode",{parentName:"a"},"rpminspect"))," can analyze your packages\nand give you information related to licensing, metadata, manpages, desktop app\nmetadata, file ownership & permissions and much much more."),(0,i.yg)("p",null,"Here's a tmt plan you can use to have rpminspect invoked on SRPMs and binary RPMs built in Copr\n(these are available by Testing Farm in ",(0,i.yg)("inlineCode",{parentName:"p"},"/var/share/test-artifacts"),"):"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},"summary:\n    Check rpm files with rpminspect\ndiscover:\n    how: shell\n    tests:\n      - name: rpminspect SRPM and RPMs\n        test: for rpm in /var/share/test-artifacts/*.rpm; do rpminspect-fedora -E metadata $rpm; done\nprepare:\n  - name: packages\n    how: install\n    package:\n    - rpminspect\n    - rpminspect-data-fedora\nexecute:\n    how: tmt\nadjust:\n    enabled: false\n    when: distro == centos-stream-9\n")),(0,i.yg)("p",null,"You can run rpminspect also using the CentOS Stream configuration (see also the ",(0,i.yg)("inlineCode",{parentName:"p"},"adjust")," section in the snippets).\nThis should prepare you before opening CentOS Stream dist-git MRs:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},"summary:\n    Check rpm files with rpminspect\ndiscover:\n    how: shell\n    tests:\n      - name: rpminspect SRPM and RPMs\n        test: for rpm in /var/share/test-artifacts/*.rpm; do rpminspect-centos -E metadata -v -t VERIFY --profile=centos-stream-9-devel $rpm; done\nprepare:\n  - name: packages\n    how: install\n    package:\n    - rpminspect\n    - rpminspect-data-centos\nexecute:\n    how: tmt\nadjust:\n    enabled: false\n    when: distro == fedora\n")),(0,i.yg)("p",null,"As these plans rely on the Testing Farm environment (downloaded RPMs), they are not reproducible manually, but you can reproduce them\nvia ",(0,i.yg)("inlineCode",{parentName:"p"},"tmt-reproducer.sh")," provided by Testing Farm."),(0,i.yg)("p",null,"Since rpminspect is under active development, you should consider installing the latest version from this Copr project: ",(0,i.yg)("a",{parentName:"p",href:"https://copr.fedorainfracloud.org/coprs/dcantrell/rpminspect/"},"https://copr.fedorainfracloud.org/coprs/dcantrell/rpminspect/")),(0,i.yg)("h3",{id:"csmock"},"csmock"),(0,i.yg)("p",null,"You can not only run linters on your SRPM file but also run static/dynamic analysis using ",(0,i.yg)("a",{parentName:"p",href:"https://github.com/csutils/csmock"},"csmock"),"."),(0,i.yg)("p",null,"Here is a test definition of the check: (The result manipulation is here to be able to see the html report directly on the Testing Farm Result page.)"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-yaml"},"summary:\n    Check SRPM files with csmock\ndiscover:\n    how: shell\n    tests:\n      - name: csmock\n        test: \"csmock --all-tools /tmp/*.src.rpm -o $TMT_TEST_DATA --force && echo -e '- result: pass' > $TMT_TEST_DATA/results.yaml || echo -e '- result: fail' > $TMT_TEST_DATA/results.yaml ; echo -e '  name: /\\n  log:\\n  - scan.log\\n  - scan-results.html' >> $TMT_TEST_DATA/results.yaml\"\n        result: custom\n        require: bash\nprepare:\n  - name: packages\n    how: install\n    package:\n    - csmock\n  - how: shell\n    script: cd /tmp && curl -O ${PACKIT_SRPM_URL}\nexecute:\n    how: tmt\n")),(0,i.yg)("h2",{id:"testing-farm-api"},"Testing Farm API"),(0,i.yg)("p",null,"Packit Service communicates with Testing Farm via its ",(0,i.yg)("a",{parentName:"p",href:"https://api.testing-farm.io"},"API"),"."),(0,i.yg)("h3",{id:"public-ids-of-packit-tokens-for-using-secrets"},"Public IDs of Packit tokens (for using secrets)"),(0,i.yg)("p",null,"For the encryption of secrets to be used by Packit-triggered tests, you need to\nencrypt the secrets with our public token ID and the git repo from which tests\nare going to be triggered. Below is an enumeration of our public IDs:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Public ranch: ",(0,i.yg)("inlineCode",{parentName:"li"},"0cfc00a8-94d7-4408-babc-4d0bc43821ea")),(0,i.yg)("li",{parentName:"ul"},"RH-internal ranch",(0,i.yg)("ul",{parentName:"li"},(0,i.yg)("li",{parentName:"ul"},"Packit Production: ",(0,i.yg)("inlineCode",{parentName:"li"},"ea2a89aa-6a78-40e0-906e-140f623c45b0")),(0,i.yg)("li",{parentName:"ul"},"Packit Stage: ",(0,i.yg)("inlineCode",{parentName:"li"},"c91ea8cc-d8f6-4b83-a80c-fefd45ff25e4"))))),(0,i.yg)("admonition",{type:"tip"},(0,i.yg)("p",{parentName:"admonition"},"In case of any discrepancies, you should still be able to see the public ID and\nthe git repo passed by Packit by triggering the TF run via Packit, and opening\nthe original API request by Packit from the TF artifacts page.")),(0,i.yg)("p",null,"For the details on how to configure the secrets, please see the Testing Farm\n",(0,i.yg)("a",{parentName:"p",href:"https://docs.testing-farm.io/Testing%20Farm/0.1/test-request.html#secrets-in-repo-config"},"documentation"),"."),(0,i.yg)("admonition",{type:"warning"},(0,i.yg)("p",{parentName:"admonition"},"If you wish to utilize secrets in tests when submitting pull requests from\nforks, you need to encrypt the secrets for each of the forks that will trigger\nthe tests.")),(0,i.yg)("h2",{id:"issues--rfes"},"Issues & RFEs"),(0,i.yg)("p",null,"If you have found an issue or have an RFE, you can file an ",(0,i.yg)("a",{parentName:"p",href:"https://gitlab.com/testing-farm/general/-/issues"},"issue in nucleus project"),"."))}u.isMDXComponent=!0}}]);