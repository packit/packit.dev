"use strict";(self.webpackChunkpackit_dev=self.webpackChunkpackit_dev||[]).push([[6318],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>g});var r=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},s=Object.keys(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)n=s[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var c=r.createContext({}),p=function(e){var t=r.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},u=function(e){var t=p(e.components);return r.createElement(c.Provider,{value:t},e.children)},m="mdxType",l={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,s=e.originalType,c=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),m=p(n),d=o,g=m["".concat(c,".").concat(d)]||m[d]||l[d]||s;return n?r.createElement(g,a(a({ref:t},u),{},{components:n})):r.createElement(g,a({ref:t},u))}));function g(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var s=n.length,a=new Array(s);a[0]=d;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i[m]="string"==typeof e?e:o,a[1]=i;for(var p=2;p<s;p++)a[p]=n[p];return r.createElement.apply(null,a)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},22967:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>l,frontMatter:()=>s,metadata:()=>i,toc:()=>p});var r=n(87462),o=(n(67294),n(3905));const s={title:"Summit 2020 Demo",authors:"ttomecek"},a="This is how I totally not faked the demo",i={unversionedId:"user-stories/summit-demo",id:"user-stories/summit-demo",title:"Summit 2020 Demo",description:"Create project",source:"@site/research/user-stories/summit-demo.md",sourceDirName:"user-stories",slug:"/user-stories/summit-demo",permalink:"/research/user-stories/summit-demo",draft:!1,editUrl:"https://github.com/packit/research/tree/main/research/user-stories/summit-demo.md",tags:[],version:"current",frontMatter:{title:"Summit 2020 Demo",authors:"ttomecek"},sidebar:"autogenerated",previous:{title:"New python package to Fedora",permalink:"/research/user-stories/python_project_from_scratch"},next:{title:"Triggering testing farm tests with builds from other PRs (projects)",permalink:"/research/user-stories/tests-builds-from-more-prs"}},c={},p=[{value:"Create project",id:"create-project",level:2},{value:"Push stuff",id:"push-stuff",level:2},{value:"Create a PR",id:"create-a-pr",level:2},{value:"Build",id:"build",level:2},{value:"Update check status",id:"update-check-status",level:2},{value:"Review and accept",id:"review-and-accept",level:2},{value:"Run locally",id:"run-locally",level:2}],u={toc:p},m="wrapper";function l(e){let{components:t,...n}=e;return(0,o.kt)(m,(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"this-is-how-i-totally-not-faked-the-demo"},"This is how I totally not faked the demo"),(0,o.kt)("h2",{id:"create-project"},"Create project"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Go here ",(0,o.kt)("a",{parentName:"p",href:"https://git.stg.centos.org/"},"https://git.stg.centos.org/"))),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Log in. (use prod credentials, there doesn't seem to be stg.accounts)")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("a",{parentName:"p",href:"https://git.stg.centos.org/settings/token/new"},"Create your personal API token.")," Tick:"))),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Fork a project"),(0,o.kt)("li",{parentName:"ul"},"Modify an existing project"),(0,o.kt)("li",{parentName:"ul"},"Open a new pull-request")),(0,o.kt)("p",null,"Though in the next sample we'd use the packit user token to create the source-git repo."),(0,o.kt)("p",null,"Now the code I ran:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},'In [1]: import ogr\n\nIn [2]: s = ogr.PagureService(token="da_token", instance_url="https://git.stg.centos.org/")\n\nIn [4]: s.get_api_url()\nOut[4]: \'https://git.stg.centos.org//api/0/\'\n\nIn [9]: p = s.project_create(repo="rpm-demo", namespace="source-git")\n')),(0,o.kt)("p",null,"And voil\xe0... ",(0,o.kt)("a",{parentName:"p",href:"https://git.stg.centos.org/source-git/rpm-demo"},"https://git.stg.centos.org/source-git/rpm-demo")),(0,o.kt)("p",null,"Now we need to grant our group the commit access (use packit's token - it can be found in secrets/stg/p-s.yaml):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-python"},"In [30]: mod_acls = {\n    ...:     'user_type': 'group',\n    ...:     'name': 'git-packit-team',\n    ...:     'acl': 'commit',\n    ...: }\n\nIn [31]: s.call_api(s.get_api_url() + 'source-git/rpm-demo/git/modifyacls', \"POST\", data=mod_acls)\n")),(0,o.kt)("h2",{id:"push-stuff"},"Push stuff"),(0,o.kt)("p",null,"Let's push rpm source-git content to the repo."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ upsint fork packit-service-testing-organisation/source-git-rpm\n16:11:33 INFO   forking repo packit-service-testing-organisation/source-git-rpm to TomasTomecek\n16:11:34 DEBUG  clone git@github.com:TomasTomecek/source-git-rpm.git\nCloning into 'source-git-rpm'...\nremote: Enumerating objects: 1373, done.\nremote: Counting objects: 100% (1373/1373), done.\nremote: Compressing objects: 100% (777/777), done.\nremote: Total 1373 (delta 490), reused 1372 (delta 489), pack-reused 0\nReceiving objects: 100% (1373/1373), 5.03 MiB | 1.17 MiB/s, done.\nResolving deltas: 100% (490/490), done.\n16:11:41 DEBUG  clone return code: 0\n16:11:41 DEBUG  set remote upstream to https://github.com/packit-service-testing-organisation/source-git-rpm.git\n16:11:41 DEBUG  adding fetch rule to get PRs for upstream\n16:11:41 DEBUG  set remote origin to git@github.com:TomasTomecek/source-git-rpm.git\n16:11:41 DEBUG  adding fetch rule to get PRs for origin\n16:11:41 DEBUG  fetching everything\nremote: Enumerating objects: 8, done.\nremote: Counting objects: 100% (8/8), done.\nremote: Compressing objects: 100% (2/2), done.\nremote: Total 6 (delta 4), reused 6 (delta 4), pack-reused 0\nUnpacking objects: 100% (6/6), 1.26 KiB | 214.00 KiB/s, done.\nFrom https://github.com/packit-service-testing-organisation/source-git-rpm\n * [new ref]         refs/pull/1/head    -> upstream/pr/1\n * [new ref]         refs/pull/2/head    -> upstream/pr/2\n * [new ref]         refs/pull/3/head    -> upstream/pr/3\n * [new branch]      a-downstream-change -> upstream/a-downstream-change\n * [new branch]      c8s                 -> upstream/c8s\n * [new branch]      master              -> upstream/master\nFrom github.com:packit-service-testing-organisation/source-git-rpm\n * [new branch]      a-downstream-change -> upstream-w/a-downstream-change\n * [new branch]      c8s                 -> upstream-w/c8s\n * [new branch]      master              -> upstream-w/master\n\n$ cd packit-service-testing-organisation/source-git-rpm\n")),(0,o.kt)("p",null,"The main change I did in source-git was to move the spec to ",(0,o.kt)("inlineCode",{parentName:"p"},"SPECS/*.spec")," so\nthey are compatible with dist-git and one can cherry-pick patches from there."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ packit srpm\nPackit 0.8.2.dev117+g68cd942 is being used.\nInput is a directory: /home/tt/g/packit-service-testing-organisation/source-git-rpm\nInput directory is an upstream repository.\n100%[=============================>]     3.96M  eta 00:00:00\n66 patches added to /home/tt/g/packit-service-testing-organisation/source-git-rpm/centos-packaging/SPECS/rpm.spec\nSRPM is /home/tt/g/packit-service-testing-organisation/source-git-rpm/rpm-4.14.2-37.g824233d8.fc31.src.rpm\nSRPM: /home/tt/g/packit-service-testing-organisation/source-git-rpm/rpm-4.14.2-37.g824233d8.fc31.src.rpm\n")),(0,o.kt)("p",null,"Werks, nice!"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ git remote add sg ssh://git@git.stg.centos.org/source-git/rpm.git\n")),(0,o.kt)("p",null,"Let's not push to master just yet."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ git checkout -B preview\nSwitched to a new branch 'preview'\n\n$ git push -u sg --tags\nThe authenticity of host 'git.stg.centos.org (8.43.84.204)' can't be established.\nRSA key fingerprint is SHA256:e0tkihPvgWKC/ull50CaD4i40cYqPEOhVzW8jKaAa0M.\nAre you sure you want to continue connecting (yes/no/[fingerprint])? yes\nWarning: Permanently added 'git.stg.centos.org,8.43.84.204' (RSA) to the list of known hosts.\nEnumerating objects: 1367, done.\nCounting objects: 100% (1367/1367), done.\nDelta compression using up to 8 threads\nCompressing objects: 100% (774/774), done.\nWriting objects: 100% (1367/1367), 5.03 MiB | 1.65 MiB/s, done.\nTotal 1367 (delta 486), reused 1366 (delta 486)\nremote:   - to mqtt\nremote: ERROR: [u'git', u'rev-list', u'824233d87b25e8fa7211079f561c79baf34b3fa7', u'^HEAD'] =-- 128\nremote:\nremote: fatal: bad revision '^HEAD'\nremote:\nremote: Sending to redis to send commit notification emails\nTo ssh://git.stg.centos.org/source-git/rpm.git\n * [new branch]      preview -> preview\nBranch 'preview' set up to track remote branch 'preview' from 'sg'.\n")),(0,o.kt)("p",null,'In the end I did demo on a "demo" branch, not master.'),(0,o.kt)("h2",{id:"create-a-pr"},"Create a PR"),(0,o.kt)("p",null,"I did this via web ui: ",(0,o.kt)("a",{parentName:"p",href:"https://git.stg.centos.org/source-git/rpm/pull-request/1"},"https://git.stg.centos.org/source-git/rpm/pull-request/1")),(0,o.kt)("h2",{id:"build"},"Build"),(0,o.kt)("p",null,"Build kicked off locally using ",(0,o.kt)("inlineCode",{parentName:"p"},"copr-cli"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ packit srpm\n$ copr build ttomecek/centos-stream-rpm ./rpm-4.14.2-37.g8d29d36c.fc31.src.rpm\n")),(0,o.kt)("h2",{id:"update-check-status"},"Update check status"),(0,o.kt)("p",null,"Sadly the commit check status (flag in pagure terminology) did not show up:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'In [22]: cs = p.set_commit_status("8d29d36c13cf23a02d66789edb7ff735208b7ddd", CommitStatus.pending, "https://copr.fedorainfracloud.org/coprs/build/1315419", "RPM build", "The build is pending")\n\nIn [24]: cs.comment\nOut[24]: \'RPM build\'\n\nIn [25]: cs.commit\nOut[25]: \'8d29d36c13cf23a02d66789edb7ff735208b7ddd\'\n\nIn [26]: cs.context\nOut[26]: \'The build is pending\'\n\nIn [27]: cs.state\nOut[27]: <CommitStatus.pending: 1>\n\nIn [28]: cs.url\nOut[28]: \'https://copr.fedorainfracloud.org/coprs/build/1315419\'\n\nIn [38]: css = p.get_commit_statuses("8d29d36c13cf23a02d66789edb7ff735208b7ddd")\n\nIn [39]: css\nOut[39]:\n[<ogr.services.pagure.flag.PagureCommitFlag at 0x7f242f5f19d0>,\n <ogr.services.pagure.flag.PagureCommitFlag at 0x7f242f506190>]\n')),(0,o.kt)("p",null,"Instead, I posted a comment to the PR on packit's behalf:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'In [36]: msg = """\nRPM build [has finished](https://copr.fedorainfracloud.org/coprs/build/1320138).\nStatus: **succeeded**\n\nIf you wish to try the change locally, you can install it in a [ubi8](https://access.redhat.com/articles/4238681) container like this:\n\n1. Run the container first:\n    ```\n    podman run --rm -ti registry.access.redhat.com/ubi8 bash\n    ```\n2. Install the CentOS Stream repositories:\n    ```\n    dnf config-manager --add-repo=http://mirror.centos.org/centos/8-stream/BaseOS/x86_64/os/\n    ```\n    ```\n    dnf config-manager --add-repo=http://mirror.centos.org/centos/8-stream/AppStream/x86_64/os/\n    ```\n3. And finally install the build with your change:\n    ```\n    dnf copr enable ttomecek/centos-stream-rpm centos-stream-x86_64\n    ```\n    ```\n    dnf update rpm --nogpgcheck\n    ```\n"""\n\nIn [37]: pr.comment(msg)\nOut[37]: <ogr.services.pagure.comments.PagurePRComment at 0x7f242f6dec90>\n')),(0,o.kt)("h2",{id:"review-and-accept"},"Review and accept"),(0,o.kt)("p",null,"Another PR comment done via web ui, I faked the username and the icon."),(0,o.kt)("h2",{id:"run-locally"},"Run locally"),(0,o.kt)("p",null,"See the steps in the comment above."))}l.isMDXComponent=!0}}]);