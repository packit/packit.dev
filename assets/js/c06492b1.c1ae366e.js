"use strict";(self.webpackChunkpackit_dev=self.webpackChunkpackit_dev||[]).push([[8195],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>d});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=n.createContext({}),c=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},p=function(e){var t=c(e.components);return n.createElement(l.Provider,{value:t},e.children)},u="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(a),m=r,d=u["".concat(l,".").concat(m)]||u[m]||h[m]||o;return a?n.createElement(d,i(i({ref:t},p),{},{components:a})):n.createElement(d,i({ref:t},p))}));function d(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,i=new Array(o);i[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[u]="string"==typeof e?e:r,i[1]=s;for(var c=2;c<o;c++)i[c]=a[c];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},60120:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var n=a(87462),r=(a(67294),a(3905));const o={title:"Automation of the certificate renewal",authors:"jpopelka"},i=void 0,s={unversionedId:"internal-automation/cert-management",id:"internal-automation/cert-management",title:"Automation of the certificate renewal",description:"Current state",source:"@site/research/internal-automation/cert-management.md",sourceDirName:"internal-automation",slug:"/internal-automation/cert-management",permalink:"/research/internal-automation/cert-management",draft:!1,editUrl:"https://github.com/packit/research/tree/main/research/internal-automation/cert-management.md",tags:[],version:"current",frontMatter:{title:"Automation of the certificate renewal",authors:"jpopelka"},sidebar:"autogenerated",previous:{title:"Automation of internal processes",permalink:"/research/category/automation-of-internal-processes"},next:{title:"Onboard automation scripts",permalink:"/research/internal-automation/onboard/"}},l={},c=[{value:"Current state",id:"current-state",level:2},{value:"Copr",id:"copr",level:2},{value:"Other options",id:"other-options",level:2},{value:"Certbot plugins",id:"certbot-plugins",level:3},{value:"OCP way",id:"ocp-way",level:3},{value:"Openshift-acme",id:"openshift-acme",level:4},{value:"Cert-manager",id:"cert-manager",level:4},{value:"mod_md",id:"mod_md",level:3},{value:"Use a web server with automatic HTTPS, like Caddy",id:"use-a-web-server-with-automatic-https-like-caddy",level:3},{value:"Output",id:"output",level:2}],p={toc:c},u="wrapper";function h(e){let{components:t,...a}=e;return(0,r.kt)(u,(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"current-state"},"Current state"),(0,r.kt)("p",null,"As of beginning of 2022 we ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/packit/deployment#obtaining-a-lets-encrypt-cert-using-certbot"},"use certbot manually"),"\nevery 3 months to generate a new multi-domain wildcard certificate for all our\nmicroservices. The whole process takes like half an hour, but still would be\nnice to have it fully automated."),(0,r.kt)("h2",{id:"copr"},"Copr"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://pagure.io/fedora-infra/ansible/blob/main/f/roles/copr/certbot/tasks/letsencrypt.yml"},"Copr uses certbot"),"\nas well, but with automated renewals, so can we do it in a similar way?"),(0,r.kt)("p",null,"Well, I'm not sure. They run certbot and the renewal service & timer\n(systemd equivalent of cron job) on the same machine(s) as web server(s).\nBut we run our httpd/nginx in containers and probably don't want\nto have more processes (httpd/nginx + crond) running in each of the\ncontainers. For nginx, it'd also mean a separate image with crond & certbot\nbecause we use official nginx image.\nBut ",(0,r.kt)("a",{parentName:"p",href:"https://medium.com/rahasak/setup-lets-encrypt-certificate-with-nginx-certbot-and-docker-b13010a12994"},"some people do that"),"."),(0,r.kt)("p",null,"Or maybe running two containers in one pod? Does anyone has experience with that?"),(0,r.kt)("p",null,"With RWO volumes it's also not possible to run certbot+crond in another\npod with the certificate on a shared volume (because the RWO volume\ncan't be mounted to more containers)."),(0,r.kt)("h2",{id:"other-options"},"Other options"),(0,r.kt)("p",null,"Both, copr and us use ",(0,r.kt)("inlineCode",{parentName:"p"},"certbot certonly"),", they just use ",(0,r.kt)("a",{parentName:"p",href:"https://eff-certbot.readthedocs.io/en/stable/using.html#standalone"},(0,r.kt)("inlineCode",{parentName:"a"},"--standalone")),"\nwhile we use ",(0,r.kt)("a",{parentName:"p",href:"https://eff-certbot.readthedocs.io/en/stable/using.html#manual"},(0,r.kt)("inlineCode",{parentName:"a"},"--manual")),".\nBut there are more plugins, so can some of them be or any\nhelp?"),(0,r.kt)("h3",{id:"certbot-plugins"},"Certbot plugins"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://eff-certbot.readthedocs.io/en/stable/using.html#getting-certificates-and-choosing-plugins"},"There are"),"\nspecial plugins for ",(0,r.kt)("a",{parentName:"p",href:"https://eff-certbot.readthedocs.io/en/stable/using.html#apache"},"apache"),"\nand ",(0,r.kt)("a",{parentName:"p",href:"https://eff-certbot.readthedocs.io/en/stable/using.html#nginx"},"nginx"),"\nwhich might help a lot with automation, but the problem with running\ncertbot/crond+httpd/nginx in the same container still persists."),(0,r.kt)("p",null,"There are also ",(0,r.kt)("a",{parentName:"p",href:"https://eff-certbot.readthedocs.io/en/stable/using.html#dns-plugins"},"DNS plugins"),"\nwhich would probably allow us to create/renew the certificate(s) in a different\ncontainer, but there's no plugin for Google Domains, just ",(0,r.kt)("a",{parentName:"p",href:"https://certbot-dns-google.readthedocs.io/en/stable/"},"Google Cloud DNS"),"\nwhich is a different service."),(0,r.kt)("h3",{id:"ocp-way"},"OCP way"),(0,r.kt)("p",null,"Wait, there must be some Openshift/k8s native way to this."),(0,r.kt)("h4",{id:"openshift-acme"},(0,r.kt)("a",{parentName:"h4",href:"https://github.com/tnozicka/openshift-acme/tree/master/deploy#single-namespace"},"Openshift-acme")),(0,r.kt)("p",null,"is what we used to utilize as a first version of our cert management, but then\nwe switched to DNS challenge, ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/packit/deployment/commit/2d87c7b2c6711271671b54a994202fa5e65b0c4a"},"removed it"),"\nand probably don't want to return."),(0,r.kt)("h4",{id:"cert-manager"},(0,r.kt)("a",{parentName:"h4",href:"https://github.com/jetstack/cert-manager"},"Cert-manager")),(0,r.kt)("p",null,"is a Kubernetes add-on, which ",(0,r.kt)("a",{parentName:"p",href:"https://www.redhat.com/sysadmin/cert-manager-operator-openshift"},"can be installed in OCP as operator"),"\nbut requires cluster-admin privileges to do so. After installation, one also\nneeds to ",(0,r.kt)("a",{parentName:"p",href:"https://cert-manager.io/docs/configuration/acme"},"configure a specific ACME issuer"),"\nwith solver being either:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://cert-manager.io/docs/configuration/acme/dns01/"},"DNS01")," - again,\n",(0,r.kt)("a",{parentName:"li",href:"https://cert-manager.io/docs/configuration/acme/dns01/google/"},"there's no provider"),"\nfor Google Domains, just Google CloudDNS"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://cert-manager.io/docs/configuration/acme/http01/"},"HTTP01")," - looks\nlike lots of experimentation")),(0,r.kt)("h3",{id:"mod_md"},(0,r.kt)("a",{parentName:"h3",href:"https://httpd.apache.org/docs/2.4/mod/mod_md.html"},"mod_md")),(0,r.kt)("p",null,"mod_md is Apache module for automated TLS cert provisioning/renewal using ACME (Let's Encrypt).\nOne just has to tweak the httpd configuration and everything else should be automated.\nA few howtos:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://httpd.apache.org/docs/2.4/mod/mod_md.html"},"1")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.server-world.info/en/note?os=Fedora_35&p=httpd&f=10"},"2")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://frasertweedale.github.io/blog-redhat/posts/2020-05-07-ipa-acme-mod_md.html"},"3")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.root.cz/clanky/https-certifikat-let-s-encrypt-pomoci-apache-a-vestaveneho-modulu-mod-md"},"4 (czech only, this is where I found it)"))),(0,r.kt)("p",null,"The thing is that we haven't configured httpd directly since\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/packit/packit-service/pull/1363"},"we started using mod_wsgi-express"),"\nwhich configures httpd for us. So we'd need to figure out how to tweak the\nmod_wsgi-express generated httpd.conf before the server starts\nOr do we need to request ",(0,r.kt)("a",{parentName:"p",href:"https://modwsgi.readthedocs.io"},"mod_wsgi"),"\nto support mod_md in a similar way it supports mod_ssl?"),(0,r.kt)("p",null,"We'd been actually installing mod_md prior to\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/packit/packit-service/pull/1363"},"moving to mod_wsgi-express"),"\nbut AFAIK never used it (directly)."),(0,r.kt)("h3",{id:"use-a-web-server-with-automatic-https-like-caddy"},"Use a web server with ",(0,r.kt)("a",{parentName:"h3",href:"https://caddyserver.com/docs/automatic-https"},"automatic HTTPS, like Caddy")),(0,r.kt)("p",null,"How difficult the switch from httpd (API, dashboard) and nginx (metrics)\nwould be, has not been researched."),(0,r.kt)("h2",{id:"output"},"Output"),(0,r.kt)("p",null,"There's no straightforward way to automate the certificate generation/renewal\ncompletely. All options look like they'd still need a lot of experimentation\nand/or some compromises."))}h.isMDXComponent=!0}}]);