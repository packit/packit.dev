"use strict";(self.webpackChunkpackit_dev=self.webpackChunkpackit_dev||[]).push([[1260],{3905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>k});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var o=n.createContext({}),p=function(e){var t=n.useContext(o),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},u=function(e){var t=p(e.components);return n.createElement(o.Provider,{value:t},e.children)},m="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,l=e.originalType,o=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),m=p(a),d=r,k=m["".concat(o,".").concat(d)]||m[d]||c[d]||l;return a?n.createElement(k,i(i({ref:t},u),{},{components:a})):n.createElement(k,i({ref:t},u))}));function k(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=a.length,i=new Array(l);i[0]=d;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s[m]="string"==typeof e?e:r,i[1]=s;for(var p=2;p<l;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},55091:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>o,contentTitle:()=>i,default:()=>c,frontMatter:()=>l,metadata:()=>s,toc:()=>p});var n=a(87462),r=(a(67294),a(3905));const l={title:"External Testing",authors:"ttomecek"},i=void 0,s={unversionedId:"testing/external-testing",id:"testing/external-testing",title:"External Testing",description:"Let's talk about testing process against external resources. What does that",source:"@site/research/testing/external-testing.md",sourceDirName:"testing",slug:"/testing/external-testing",permalink:"/research/testing/external-testing",draft:!1,editUrl:"https://github.com/packit/research/tree/main/research/testing/external-testing.md",tags:[],version:"current",frontMatter:{title:"External Testing",authors:"ttomecek"},sidebar:"autogenerated",previous:{title:"Testing",permalink:"/research/category/testing"},next:{title:"How to make packit-service-tests-openshift OpenShift-less?",permalink:"/research/testing/openshift-to-podman-kube-play"}},o={},p=[{value:"Use cases",id:"use-cases",level:2},{value:"How we test today",id:"how-we-test-today",level:2},{value:"VCRpy vs. requre vs. betamax",id:"vcrpy-vs-requre-vs-betamax",level:2},{value:"Feelings",id:"feelings",level:3},{value:"So, what&#39;s next?",id:"so-whats-next",level:2},{value:"Solution 1: Keep using requre and improve it",id:"solution-1-keep-using-requre-and-improve-it",level:3},{value:"Solution 2: Switch to VCRpy",id:"solution-2-switch-to-vcrpy",level:3},{value:"a) Get requre&#39;s features in there",id:"a-get-requres-features-in-there",level:4},{value:"b) VCRpy + flexmock + pytest fixtures",id:"b-vcrpy--flexmock--pytest-fixtures",level:4},{value:"Not a solution 3: VCRpy + requre",id:"not-a-solution-3-vcrpy--requre",level:3},{value:"Not a solution 4: Switch to betamax",id:"not-a-solution-4-switch-to-betamax",level:3}],u={toc:p},m="wrapper";function c(e){let{components:t,...a}=e;return(0,r.kt)(m,(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Let's talk about testing process against external resources. What does that\nmean? Well, talking to GitHub API, COPR API, running ",(0,r.kt)("inlineCode",{parentName:"p"},"fedpkg"),", cloning\nrepositories..."),(0,r.kt)("h2",{id:"use-cases"},"Use cases"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Interact with an external API (such as GitHub, COPR, Pagure, FAS, k8s)",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Authenticated vs. unauthenticated calls."))),(0,r.kt)("li",{parentName:"ul"},"Clone a git repository."),(0,r.kt)("li",{parentName:"ul"},"Construct a git repository with a predefined structure by us."),(0,r.kt)("li",{parentName:"ul"},"Run a command to perform an action.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Changes happening only locally."),(0,r.kt)("li",{parentName:"ul"},"RO access to a remote service."),(0,r.kt)("li",{parentName:"ul"},"R/W access to a remote service."))),(0,r.kt)("li",{parentName:"ul"},"Combination of multiple use cases into a single test case.")),(0,r.kt)("h2",{id:"how-we-test-today"},"How we test today"),(0,r.kt)("p",null,"We have the use cases, let's see how we are solving them w/ requre (and other tools) today:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The record/replay configuration is often set outside of tests so one needs to track down matching configuration for a test case."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"upgrade_import_system().decorate(...)...")," makes it hard to know why some of the entries are in the chain.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"what"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"where")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"who_name")," are very confusing and am pretty sure that only Honza knows their true meaning."))),(0,r.kt)("li",{parentName:"ul"},"Some recorded responses are hard to pair with their respective code.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"(Example: ",(0,r.kt)("inlineCode",{parentName:"li"},"X \u2192 file \u2192 tar \u2192 StoreFiles \u2192 tests...test_comment_in_spec \u2192 ... output: !!binary"),")"))),(0,r.kt)("li",{parentName:"ul"},"WIP ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/packit-service/packit/pull/612"},"PR")," from Franta on moving more tests to use requre:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"We need to have ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/packit-service/packit/pull/612/files#diff-c2e2e7a23e6a4cefc8ba3ff9ec18c866R189"},"switches")," in code when a dependency changes its internals significantly to account for the call stack difference."),(0,r.kt)("li",{parentName:"ul"},"Fairly complex ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/packit-service/packit/pull/612/files#diff-c2e2e7a23e6a4cefc8ba3ff9ec18c866"},"testing setup"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/packit-service/packit/pull/612/files#diff-db8ce5f26d68799608c6cab5aae59fdc"},"Tests themselves")," are short and concise."),(0,r.kt)("li",{parentName:"ul"},"requre is used to record these interactions:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"HTTP communcation"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"git push")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"git fetch")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"fedpkg clone")),(0,r.kt)("li",{parentName:"ul"},"storing files (which?)"))))),(0,r.kt)("li",{parentName:"ul"},"We still have 2 PRs opened to improve testing via requre in packit and p-s, for months at this point."),(0,r.kt)("li",{parentName:"ul"},"Our integration tests use pytest features and flexmock heavily - the structure is too complex at this point.")),(0,r.kt)("h2",{id:"vcrpy-vs-requre-vs-betamax"},"VCRpy vs. requre vs. betamax"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"A feature"),(0,r.kt)("th",{parentName:"tr",align:null},"VCRpy"),(0,r.kt)("th",{parentName:"tr",align:null},"requre"),(0,r.kt)("th",{parentName:"tr",align:null},"betamax"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Record & replay for python requests"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Match on call stack"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2718"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2718 ","[5]")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Match on URL & request type"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2718"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Hooks to all requests calls automagically"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2718 ","[6]")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Calling the same URL twice works as expected"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2718"),(0,r.kt)("td",{parentName:"tr",align:null},"?")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Works with HTTPS"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:null},"?")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Record & replay for arbitrary functions"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2718"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2718")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Filtering sensitive data out of recorded responses"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713 ","[1]"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713 ","[2]"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713 ","[7]")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Easy to use"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713 ","[3]"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2718 ","[4]"),(0,r.kt)("td",{parentName:"tr",align:null},"?")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Actively maintained"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2718"),(0,r.kt)("td",{parentName:"tr",align:null},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:null},"~")))),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"[1]"," ",(0,r.kt)("a",{parentName:"li",href:"https://vcrpy.readthedocs.io/en/latest/advanced.html#filter-sensitive-data-from-the-request"},"https://vcrpy.readthedocs.io/en/latest/advanced.html#filter-sensitive-data-from-the-request")),(0,r.kt)("li",{parentName:"ul"},"[2]"," ",(0,r.kt)("a",{parentName:"li",href:"https://requre.readthedocs.io/en/latest/usages/postprocessing.html"},"https://requre.readthedocs.io/en/latest/usages/postprocessing.html")),(0,r.kt)("li",{parentName:"ul"},"[3][You can use a decorator or a context manager]","(",(0,r.kt)("a",{parentName:"li",href:"https://vcrpy.readthedocs.io/en/latest/usage.html"},"https://vcrpy.readthedocs.io/en/latest/usage.html"),")"),(0,r.kt)("li",{parentName:"ul"},"[4][Tenths of lines of code]","(",(0,r.kt)("a",{parentName:"li",href:"https://github.com/packit-service/packit/blob/master/tests_recording/__init__.py#L16"},"https://github.com/packit-service/packit/blob/master/tests_recording/__init__.py#L16"),") ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/packit-service/packit/blob/master/tests_recording/testbase.py#L22"},"which are very hard to understand")),(0,r.kt)("li",{parentName:"ul"},"[5]"," Betamax has ",(0,r.kt)("a",{parentName:"li",href:"https://betamax.readthedocs.io/en/latest/matchers.html"},"pluggable matching mechanism")),(0,r.kt)("li",{parentName:"ul"},"[6]"," This is by design: ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/betamaxpy/betamax/issues/125#issuecomment-267405773"},"https://github.com/betamaxpy/betamax/issues/125#issuecomment-267405773")),(0,r.kt)("li",{parentName:"ul"},"[7]"," ",(0,r.kt)("a",{parentName:"li",href:"https://betamax.readthedocs.io/en/latest/serializers.html"},"https://betamax.readthedocs.io/en/latest/serializers.html"))),(0,r.kt)("h3",{id:"feelings"},"Feelings"),(0,r.kt)("p",null,"These are my personal (@TomasTomecek) comments and opinions:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"VCRpy's API and documentation is focused on the record & replay use case\nwhich makes it very pleasant to work with."),(0,r.kt)("li",{parentName:"ul"},"requre's documentation and API is centered around implementation details\nwhich makes it very configurable, but unfortunately extremely hard to work\nwith - even to the point that you need to understand internals."),(0,r.kt)("li",{parentName:"ul"},"VCRpy in action:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/packit-service/packit/pull/785"},"Basic usage")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/packit-service/ogr/pull/373"},"Calling the same URL twice")))),(0,r.kt)("li",{parentName:"ul"},"The fact that requre is matching replay via call stack makes it less flexible\nand requires data regeneration more often than VCRpy."),(0,r.kt)("li",{parentName:"ul"},"In my opinion: VCRpy masters its job very well.")),(0,r.kt)("h2",{id:"so-whats-next"},"So, what's next?"),(0,r.kt)("p",null,"Hunor asked me to do an in-depth analysis for the possible solutions. We need\na team discussion to pick one."),(0,r.kt)("h3",{id:"solution-1-keep-using-requre-and-improve-it"},"Solution 1: Keep using requre and improve it"),(0,r.kt)("p",null,"We can keep using requre as we are now. But given that VCRpy has"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"very neat user experience"),(0,r.kt)("li",{parentName:"ul"},"and matches requests based on their data and not the call stack,")),(0,r.kt)("p",null,"it is very compelling to have VCRpy's experience. This means that if we stick\nto using requre, we need to improve it to match VCRpy's UX."),(0,r.kt)("p",null,"21+ story points probably and weeks of polishing it (2 sprints at least)"),(0,r.kt)("h3",{id:"solution-2-switch-to-vcrpy"},"Solution 2: Switch to VCRpy"),(0,r.kt)("p",null,"Alternatively, we can switch to VCR. There are multiple sub-options."),(0,r.kt)("h4",{id:"a-get-requres-features-in-there"},"a) Get requre's features in there"),(0,r.kt)("p",null,'Since VCRpy has "dead upstream" we would either ended up'),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"maintaining the project"),(0,r.kt)("li",{parentName:"ul"},"or forking it")),(0,r.kt)("p",null,"Definitely more work than implementing things in requre itself."),(0,r.kt)("p",null,"21++ story points (2-3 sprints)"),(0,r.kt)("h4",{id:"b-vcrpy--flexmock--pytest-fixtures"},"b) VCRpy + flexmock + pytest fixtures"),(0,r.kt)("p",null,"This implies ditching requre completely. We'd need to:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"rewrite existing tests to use VCR instead of requre (easy)"),(0,r.kt)("li",{parentName:"ul"},"regenerate or transform data (should be easy)"),(0,r.kt)("li",{parentName:"ul"},"use flexmock (or something else) for git, fedpkg..."),(0,r.kt)("li",{parentName:"ul"},"most importantly: prepare the structure well so it's not messy")),(0,r.kt)("p",null,"This should be achievable in 2 sprints."),(0,r.kt)("p",null,"Technical arguments end here and personal preference would follow."),(0,r.kt)("h3",{id:"not-a-solution-3-vcrpy--requre"},"Not a solution 3: VCRpy + requre"),(0,r.kt)("p",null,"They don't play well together. This solution doesn't make any sense."),(0,r.kt)("h3",{id:"not-a-solution-4-switch-to-betamax"},"Not a solution 4: Switch to betamax"),(0,r.kt)("p",null,'This is a no-go: we would need to "rewrite" most of our tests and patch all the\nclient libraries we use. No.'))}c.isMDXComponent=!0}}]);