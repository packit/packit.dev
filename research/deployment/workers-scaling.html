<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-research docs-doc-id-deployment/workers-scaling">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Workers scaling | Packit</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://packit.dev/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://packit.dev/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://packit.dev/research/deployment/workers-scaling"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-research-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-research-current"><meta data-rh="true" property="og:title" content="Workers scaling | Packit"><meta data-rh="true" name="description" content="What"><meta data-rh="true" property="og:description" content="What"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://packit.dev/research/deployment/workers-scaling"><link data-rh="true" rel="alternate" href="https://packit.dev/research/deployment/workers-scaling" hreflang="en"><link data-rh="true" rel="alternate" href="https://packit.dev/research/deployment/workers-scaling" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://STHKG8EYKZ-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Packit" href="/opensearch.xml">





<link rel="alternate" type="application/rss+xml" href="/posts/rss.xml" title="Packit Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/posts/atom.xml" title="Packit Blog Atom Feed">
<link rel="alternate" type="application/json" href="/posts/feed.json" title="Packit Blog JSON Feed">
<link rel="alternate" type="application/rss+xml" href="/posts/weekly/rss.xml" title="Packit Weekly RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/posts/weekly/atom.xml" title="Packit Weekly Atom Feed">
<link rel="alternate" type="application/json" href="/posts/weekly/feed.json" title="Packit Weekly JSON Feed"><link rel="stylesheet" href="/assets/css/styles.3595ad89.css">
<link rel="preload" href="/assets/js/runtime~main.cb858bf0.js" as="script">
<link rel="preload" href="/assets/js/main.83fc030a.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Packit Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Packit Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Packit</b></a><a class="navbar__item navbar__link" href="/docs">Documentation</a><a class="navbar__item navbar__link" href="/source-git">Source-git</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/development">Development</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/deployment">Deployment</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/research">Research</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/posts">Blog Posts</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/posts/weekly">Weekly Updates</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://dashboard.packit.dev" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Dashboard<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://status.packit.dev/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Status<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/packit" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/research">Research notes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/research/job_referencing">Job referencing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/research/making-decisions">Making decisions in our projects</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/research/automation-tools">Tools/libraries similar or related to the Packit</a><button aria-label="Toggle the collapsible sidebar category &#x27;Tools/libraries similar or related to the Packit&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/research/category/celery">Celery</a><button aria-label="Toggle the collapsible sidebar category &#x27;Celery&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/research/category/database">Database</a><button aria-label="Toggle the collapsible sidebar category &#x27;Database&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/research/category/deployment">Deployment</a><button aria-label="Toggle the collapsible sidebar category &#x27;Deployment&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/research/deployment/automation-for-stable-branches">Automation for moving the stable branches</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/research/deployment/automotive-rosa">Automotive clusters</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/research/deployment/deploy-packit-pr">Deploy a testing instance</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/research/deployment/deployment-improvements">Packit Service deployment improvements</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/research/deployment/distributed-workers">Distributed workers</a><button aria-label="Toggle the collapsible sidebar category &#x27;Distributed workers&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/research/deployment/verification">Deployment and testing strategies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/research/deployment/workers-scaling">Workers scaling</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/research/deprecation">Deprecation policy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/research/git-notes">Git Notes</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/research/category/integrations">Integrations</a><button aria-label="Toggle the collapsible sidebar category &#x27;Integrations&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/research/category/automation-of-internal-processes">Automation of internal processes</a><button aria-label="Toggle the collapsible sidebar category &#x27;Automation of internal processes&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/research/monitoring">Monitoring &amp; Metrics</a><button aria-label="Toggle the collapsible sidebar category &#x27;Monitoring &amp; Metrics&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/research/monorepo-support">Monorepos</a><button aria-label="Toggle the collapsible sidebar category &#x27;Monorepos&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/research/outages">How to manage outages</a><button aria-label="Toggle the collapsible sidebar category &#x27;How to manage outages&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/research/source-git">Source-Git</a><button aria-label="Toggle the collapsible sidebar category &#x27;Source-Git&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/research/category/specfiles">Specfiles</a><button aria-label="Toggle the collapsible sidebar category &#x27;Specfiles&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/research/category/testing">Testing</a><button aria-label="Toggle the collapsible sidebar category &#x27;Testing&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/research/category/user-interface">User Interface</a><button aria-label="Toggle the collapsible sidebar category &#x27;User Interface&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/research/user-stories">User Stories</a><button aria-label="Toggle the collapsible sidebar category &#x27;User Stories&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/research/category/user-experience">User Experience</a><button aria-label="Toggle the collapsible sidebar category &#x27;User Experience&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/research/workflow-engines">Workflow engines</a><button aria-label="Toggle the collapsible sidebar category &#x27;Workflow engines&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/research/category/deployment"><span itemprop="name">Deployment</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Workers scaling</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Workers scaling</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what">What<a href="#what" class="hash-link" aria-label="Direct link to What" title="Direct link to What">​</a></h2><p>This research is about scaling worker(s) that do short-running tasks to <a href="https://github.com/packit/research/tree/main/improve-service-processing#problematic-parts-of-the-process" target="_blank" rel="noopener noreferrer">improve Packit Service event processing</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="history">History<a href="#history" class="hash-link" aria-label="Direct link to History" title="Direct link to History">​</a></h2><p>Once upon a time there were more (two?) workers who were not picky and took
whatever task they find in the (only) queue.
To not waste time they always assigned more (4) tasks at a time to themselves
before starting to work on a task.
It <a href="https://github.com/packit/packit-service/issues/375" target="_blank" rel="noopener noreferrer">could then happen</a>
that one worker processed a <code>copr_build_finished</code> event sooner than the other
worker processed a corresponding <code>copr_build_started</code> event,
and then it looked like that the copr build never finished.</p><p>For example, if you have 2 workers and a task queue like</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">build1_start | build2_start | build3_start | build1_end | build2_end | build3_end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and each worker takes 4 tasks, then the first worker takes</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">build1_start | build2_start | build3_start | build1_end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and the second is left with</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">build2_end | build3_end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>and by the time the first worker starts processing <code>build2_start</code>,
the second has already processed <code>build2_end</code> so it looks like the build2 never ended.</p><p>This <a href="https://github.com/packit/packit-service/commit/5d199cfee54dafd9a5cd5dadc1086e15d78598e5" target="_blank" rel="noopener noreferrer">has been fixed</a>
by making sure that the workers are not so greedy and reserve only one task ahead
(<code>--prefetch-multiplier=1</code>, default is 4).</p><p>Later, we also <a href="https://github.com/packit/packit-service/commit/617c76ef77ef37bc220b029bc49326d3841c54c0" target="_blank" rel="noopener noreferrer">set up 2 Celery queues, for long and short running tasks</a>
because that&#x27;s what <a href="https://docs.celeryq.dev/en/stable/userguide/optimizing.html#optimizing-prefetch-limit" target="_blank" rel="noopener noreferrer">Celery User Guide suggests</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="worker---concurrency">worker --concurrency<a href="#worker---concurrency" class="hash-link" aria-label="Direct link to worker --concurrency" title="Direct link to worker --concurrency">​</a></h2><p>The same <a href="https://github.com/packit/packit-service/commit/5d199cfee54dafd9a5cd5dadc1086e15d78598e5" target="_blank" rel="noopener noreferrer">commit</a>
that set <code>--prefetch-multiplier=1</code> also set <code>--concurrency=1</code>
(number of concurrent worker processes/threads executing tasks)
even it&#x27;s probably had no effect because <a href="https://docs.celeryq.dev/en/stable/userguide/configuration.html#std-setting-worker_concurrency" target="_blank" rel="noopener noreferrer">the default is &quot;number of CPUs/cores on the host&quot;</a>
and the workers have no more than one core.
We definitely don&#x27;t want to change the prefetch multiplier because that might
cause <a href="https://github.com/packit/packit-service/issues/375" target="_blank" rel="noopener noreferrer">p-s#375</a>
for no significant benefit, but having more concurrent worker threads
should hopefully be safe.</p><p>Whether it&#x27;s really safe depends on how Celery
fetches messages for the worker&#x27;s threads. If it waits for all threads
to finish their tasks before fetching a new batch of messages (times prefetch-multiplier)
for all threads then we might still hit <a href="https://github.com/packit/packit-service/issues/375" target="_blank" rel="noopener noreferrer">p-s#375</a>
if we have more workers serving the short-running-tasks queue.
But if Celery fetches a new message(s) for a thread once it finishes a task
without waiting for other threads then we should be fine (as long as prefetch-multiplier=1).
I checked the <a href="https://github.com/celery/celery" target="_blank" rel="noopener noreferrer">Celery source code</a>
but couldn&#x27;t find an answer for how/when it fetches messages for the threads
(whether individually or for all at once). Someone&#x27;s up for a challenge?;)
But if we had only one worker (with more threads) serving the
short-running-tasks queue then we should be fine anyway.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="processes-vs-threads-aka-celery-execution-pool">Processes vs. threads aka. <a href="https://www.distributedpython.com/2018/10/26/celery-execution-pool" target="_blank" rel="noopener noreferrer">Celery execution pool</a><a href="#processes-vs-threads-aka-celery-execution-pool" class="hash-link" aria-label="Direct link to processes-vs-threads-aka-celery-execution-pool" title="Direct link to processes-vs-threads-aka-celery-execution-pool">​</a></h3><ul><li><strong>Processes</strong> (<code>prefork</code> pool) -
are good when tasks are CPU bound. The number of processes should not exceed
the number of CPUs on host.</li><li><strong>Threads</strong> (<a href="https://docs.celeryq.dev/en/latest/userguide/concurrency/eventlet.html" target="_blank" rel="noopener noreferrer">eventlet</a>/<a href="https://www.gevent.org" target="_blank" rel="noopener noreferrer">gevent</a> pool) -
when tasks are I/O or network bound. The number of greenlets (green threads) is
unrelated to the number of CPUs on host and can go even to thousands.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="worker---autoscale">worker --autoscale<a href="#worker---autoscale" class="hash-link" aria-label="Direct link to worker --autoscale" title="Direct link to worker --autoscale">​</a></h3><p>Regarding the <code>--concurrency</code> value, we even don&#x27;t have to set a static number
if we use <a href="https://docs.celeryq.dev/en/latest/userguide/workers.html#autoscaling" target="_blank" rel="noopener noreferrer">worker --autoscale</a>
which dynamically resizes the pool based on load (<a href="https://github.com/celery/celery/blob/aa9fd8a6c06e69c7eda2a59866c3d84622c85d20/celery/worker/autoscale.py#L85" target="_blank" rel="noopener noreferrer">number of requests</a>
in the message queue, not a CPU load).</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetesopenshift-horizontal-pod-autoscaling">Kubernetes/Openshift Horizontal Pod Autoscaling<a href="#kubernetesopenshift-horizontal-pod-autoscaling" class="hash-link" aria-label="Direct link to Kubernetes/Openshift Horizontal Pod Autoscaling" title="Direct link to Kubernetes/Openshift Horizontal Pod Autoscaling">​</a></h2><ul><li><a href="https://docs.openshift.com/container-platform/4.10/nodes/pods/nodes-pods-autoscaling.html" target="_blank" rel="noopener noreferrer">Automatically scaling pods with the horizontal pod autoscaler </a></li><li><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale" target="_blank" rel="noopener noreferrer">Horizontal Pod Autoscaling</a></li></ul><p>The horizontal pod autoscaler (HPA) can be used to specify how should K8s/Openshift
scale a StatefulSet based on metrics collected from the pods.
The supported metrics are CPU and/or memory utilization.</p><p>For example: You say that you want to have 1 to 5 workers with average CPU
utilization around 50% (of their cpu resource request). The HPA controller
then periodically checks the cpu metrics and scales the pods up/down
based on the CPU consumption.</p><p>The memory utilization of short-running workers is constant so that&#x27;s off the table.
CPU utilization doesn&#x27;t quite follow the load (of tasks in queue) because the tasks
are mostly network bound. For example at times when there&#x27;s not much to do a
short-running worker consumes about 2 millicores, while when there&#x27;s a lots of tasks
the utilization jumps between 2 and 20 millicores, so it&#x27;s hard to decide on a
desired average utilization.</p><p>The ideal metric for us would be a number of outstanding tasks in a queue,
however <a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/#autoscaling-on-metrics-not-related-to-kubernetes-objects" target="_blank" rel="noopener noreferrer">external metrics</a>
are not clearly described how to achieve.</p><p>We&#x27;d also need to return <a href="https://github.com/packit/deployment/pull/142" target="_blank" rel="noopener noreferrer">readiness probes</a>
to make the HPA work.</p><p>Compared to <code>worker --autoscale</code> the HPA looks like:</p><ul><li>less reliable (if we used the CPU metrics)</li><li>more work to set up (if we used custom/external metrics - queue size)</li><li>slower - starting a pod is way slower than adding a thread</li><li>more resource hungry - running 4 pods eats much more memory than running 1 pod with 4 threads</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="summarysuggestion">Summary/Suggestion<a href="#summarysuggestion" class="hash-link" aria-label="Direct link to Summary/Suggestion" title="Direct link to Summary/Suggestion">​</a></h2><ul><li>Default for stg &amp; dev can stay as it is, i.e. <a href="https://github.com/packit/deployment/blob/cb47f9e6f806f9e340669031c7eb58df02b164f1/playbooks/deploy.yml#L40" target="_blank" rel="noopener noreferrer">one worker for all tasks</a>
with no concurrency/autoscaling/prefetching.</li><li>For prod, we should experiment with setting <code>--autoscale</code> (or just <code>--concurrency</code>)
together with <code>--pool=eventlet/gevent</code>. We should have only <a href="https://github.com/packit/deployment/blob/cb47f9e6f806f9e340669031c7eb58df02b164f1/vars/packit/prod_template.yml#L77" target="_blank" rel="noopener noreferrer">one worker for serving
short-running tasks</a>
which would autoscale based on load and <a href="https://github.com/packit/deployment/blob/cb47f9e6f806f9e340669031c7eb58df02b164f1/vars/packit/prod_template.yml#L76" target="_blank" rel="noopener noreferrer">no worker for all tasks</a>
to avoid <a href="https://github.com/packit/packit-service/issues/375" target="_blank" rel="noopener noreferrer">p-s#375</a> regression.</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/packit/research/tree/main/research/deployment/workers-scaling.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/research/deployment/verification"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Deployment and testing strategies</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/research/deprecation"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Deprecation policy</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what" class="table-of-contents__link toc-highlight">What</a></li><li><a href="#history" class="table-of-contents__link toc-highlight">History</a></li><li><a href="#worker---concurrency" class="table-of-contents__link toc-highlight">worker --concurrency</a><ul><li><a href="#processes-vs-threads-aka-celery-execution-pool" class="table-of-contents__link toc-highlight">Processes vs. threads aka. Celery execution pool</a></li><li><a href="#worker---autoscale" class="table-of-contents__link toc-highlight">worker --autoscale</a></li></ul></li><li><a href="#kubernetesopenshift-horizontal-pod-autoscaling" class="table-of-contents__link toc-highlight">Kubernetes/Openshift Horizontal Pod Autoscaling</a></li><li><a href="#summarysuggestion" class="table-of-contents__link toc-highlight">Summary/Suggestion</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/guide">Onboarding guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/fedora-releases-guide">Fedora releases guide</a></li></ul></div><div class="col footer__col"><div class="footer__title">Contact</div><ul class="footer__items clean-list"><li class="footer__item">
                  <a href="https://chat.fedoraproject.org/#/room/#packit:fedora.im">
                    #packit:fedora.im
                  </a> (Element / Matrix)
                </li><li class="footer__item">
                  <a href="https://libera.chat/">
                    #packit:libera.chat
                  </a> (IRC)
                </li><li class="footer__item">
                  <a href="mailto:hello@packit.dev">hello@packit.dev</a>
                </li><li class="footer__item">
                  <a href="https://fosstodon.org/@packit" rel="me">
                    @packit@fosstodon.org
                  </a> (Mastodon)
                </li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/usage">Usage Charts</a></li><li class="footer__item"><a class="footer__link-item" href="/posts">Blog Posts</a></li><li class="footer__item"><a href="https://github.com/packit" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Packit is a Red Hat sponsored free software project. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.cb858bf0.js"></script>
<script src="/assets/js/main.83fc030a.js"></script>
</body>
</html>